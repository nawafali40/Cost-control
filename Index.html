<!DOCTYPE html>

<html dir="rtl" lang="ar">
<head>
<meta charset="utf-8"/>
<title>ูุธุงู ุชูุงููู ูุฌุฑุฏ ุงููุฎุฒูู</title>
<style>
body{
  font-family:Arial,Helvetica,sans-serif;
  margin:0;
  direction:rtl;
  background:#020617;
  color:#e5e7eb;
}
.navbar{
  background:#020617;
  color:#f9fafb;
  padding:10px 16px;
  display:flex;
  justify-content:space-between;
  align-items:center;
  border-bottom:1px solid #1f2937;
  position:sticky;
  top:0;
  z-index:10;
  overflow-x: auto;
}
.nav-title{
  font-size:16px;
  font-weight:bold;
  flex-shrink: 0;
}
.nav-buttons{
  display: flex;
  flex-shrink: 0;
}
.nav-buttons button{
  margin-inline:4px;
  padding:6px 12px;
  border-radius:999px;
  border:none;
  cursor:pointer;
  font-size:12px;
  transition:background .15s,transform .1s;
  flex-shrink: 0;
}
.nav-buttons button.active{
  background:#f97316;
  color:#111827;
}
.nav-buttons button.inactive{
  background:#111827;
  color:#e5e7eb;
}
.nav-buttons button:hover{
  transform:translateY(-1px);
}
.page{
  max-width:1100px;
  margin:16px auto 24px;
  background:#020617;
  padding:20px;
  border-radius:16px;
  box-shadow:0 18px 45px rgba(0,0,0,.45);
  border:1px solid #1e293b;
  display:none;
}
.page.active{
  display:block;
}
h2{
  margin-top:0;
  font-size:18px;
  color:#f9fafb;
}
h3{
    font-size: 15px;
    margin-top: 18px;
}
table{
  width:100%;
  border-collapse:collapse;
  margin-top:10px;
  font-size:13px;
}
td,th{
  border:1px solid #1f2937;
  padding:6px;
  text-align:center;
}
th{
  background:#020617;
  color:#f97316;
  font-weight:600;
}
input,select,button.action{
  padding:6px 8px;
  border-radius:8px;
  border:1px solid #374151;
  font-size:13px;
  box-sizing:border-box;
  background:#020617;
  color:#e5e7eb;
}
input::placeholder{
  color:#6b7280;
}
input,select{
  width:100%;
}
button.action{
  cursor:pointer;
  background:#f97316;
  color:#111827;
  border:none;
  font-weight:600;
}
button.action:hover{
  background:#ea580c;
}
button.secondary{
  background:#111827;
  color:#e5e7eb;
  border:1px solid #374151;
  cursor:pointer;
}
button.secondary:hover{
  background:#1f2937;
}
.small{
  font-size:11px;
  color:#9ca3af;
}
.unit-label{
  font-size:11px;
  color:#9ca3af;
  margin-right:4px;
}
.btn-row{
  margin-top:10px;
  display:flex;
  gap:8px;
  flex-wrap:wrap;
}
.summary-table{
  margin-top:10px;
}
/* ุชูุณูู ุงูุฃุฎุทุงุก */
.bad{
  background:#450a0a !important;
  color:#fecaca;
  border-color:#fca5a5 !important;
}
.bad .prod-total-line, .bad .mix-total-line{
    color: #fca5a5;
}
.error-text{
  font-size:11px;
  color:#fecaca;
  text-align:right;
}
.product-block, .mix-block{
  border:1px solid #1f2937;
  border-radius:14px;
  padding:10px 10px 12px;
  margin-top:12px;
  background:#020617;
  transition:border-color 0.3s;
}
.prod-header, .mix-header{
  display:flex;
  flex-wrap:wrap;
  gap:8px;
  align-items:center;
  justify-content:space-between;
  margin-bottom:6px;
}
.prod-header-left, .mix-header-left{
  flex:1 1 auto;
  display:flex;
  gap:6px;
  align-items:center;
}
.prod-header-left input, .mix-header-left input{
  flex:1 1 auto;
}
.prod-total-line, .mix-total-line{
  margin-top:6px;
  font-size:12px;
  font-weight:bold;
  text-align:left;
  color:#f97316;
}
hr.divider{
  border:none;
  border-top:1px dashed #334155;
  margin:8px 0 12px;
}
.bad input,
.bad select{
  border-color:#fca5a5;
}
.variance-td-over {
    background: #064e3b;
    color: #a7f3d0;
}
.variance-td-short {
    background: #7f1d1d;
    color: #fecaca;
}
</style>
</head>
<body>
<div class="navbar">
<div class="nav-title">ูุธุงู ุชูุงููู ูุฌุฑุฏ</div>
<div class="nav-buttons">
<button class="active" id="btnDef" onclick="showPage('def')">๐ฆ ุชุนุฑูู ุงูููุงุฏ ุงูุฃุณุงุณูุฉ</button>
<button class="inactive" id="btnMix" onclick="showPage('mix')">๐งช ุงูุฎูุทุงุช</button>
<button class="inactive" id="btnProd" onclick="showPage('prod')">โ ุงูููุชุฌุงุช / ุงููุตูุงุช</button>
<button class="inactive" id="btnPurchases" onclick="showPage('purchases')">๐ ุงููุดุชุฑูุงุช</button>
<button class="inactive" id="btnWaste" onclick="showPage('waste')">๐๏ธ ุงููุฏุฑ ูุงููุงูุฏ</button>
<button class="inactive" id="btnSales" onclick="showPage('sales')">๐ ุงููุจูุนุงุช</button>
<button class="inactive" id="btnInvLevels" onclick="showPage('invlevels')">๐ ูุณุชููุงุช ุงููุฎุฒูู</button>
<button class="inactive" id="btnVariance" onclick="showPage('variance')">โ๏ธ ุงูุฌุฑุฏ ูุงูููุงุฑูุฉ</button>
</div>
</div>

<div class="page active" id="pageDef">
    <h2>๐ฆ ุตูุญุฉ ุชุนุฑูู ุงูููุงุฏ ุงูุฃุณุงุณูุฉ</h2>
    <p class="small">
        ุฃุฏุฎู ุงุณู ุงููุงุฏุฉุ ูุญุฏุฉ ุงูุดุฑุงุกุ ุงููููุฉ ุงููููุฉุ ูุงูุณุนุฑ ุงูุฅุฌูุงูู **ูุชุนุฑูู ุงููุงุฏุฉ ูุญุณุงุจ ุณุนุฑ ุงููุญุฏุฉ ุงูุฃุณุงุณูุฉ**.
        <br/>๐ซ ูุง ูุณูุญ ุจุชูุฑุงุฑ ููุณ ุงุณู ุงููุงุฏุฉ. ูุฐุง ุงูุณุนุฑ ูู ูุง ููุนุชูุฏ ุนููู ูู ุญุณุงุจุงุช ุงูุชูุงููู.
    </p>
    <div style="display: flex; gap: 10px; flex-wrap: wrap;">
        <input id="defName" placeholder="ุงุณู ุงููุงุฏุฉ (ูุซุงู: ุญููุจ ูุงูู ุงูุฏุณู)" style="flex: 1 1 200px;"/>
        <select id="defUnit" style="flex: 1 1 100px;">
            <option value="kg">ูููู (Kg)</option>
            <option value="g">ุฌุฑุงู (g)</option>
            <option value="l">ูุชุฑ (L)</option>
            <option value="ml">ูู (ml)</option>
            <option value="pc">ุญุจุฉ (Pc)</option>
        </select>
        <input id="defQty" placeholder="ุงููููุฉ ุงููุดุชุฑุงุฉ (ูุซุงู: 10)" type="number" style="flex: 1 1 100px;"/>
        <input id="defPrice" placeholder="ุงูุณุนุฑ ุงูุฅุฌูุงูู (ูุซุงู: 950)" type="number" style="flex: 1 1 100px;"/>
    </div>
    <div class="btn-row">
        <button class="action" onclick="addIngredientDef()">ุฅุถุงูุฉ / ุชุญุฏูุซ ุชุนุฑูู ุงููุงุฏุฉ</button>
    </div>
    <h3 style="margin-top: 15px;">ูุงุฆูุฉ ููุงุฏ ุงููุฎุฒูู ุงููุนุฑูุฉ ุญุงููุงู</h3>
    <table id="defTbl">
        <tr><th>ุงููุงุฏุฉ</th><th>ุงููุญุฏุฉ ุงูุฃุณุงุณูุฉ</th><th>ุณุนุฑ ุงููุญุฏุฉ ุงูุฃุณุงุณูุฉ ุงูุญุงูู</th><th>ุญุฐู</th></tr>
    </table>
</div>

<div class="page" id="pageMix">
    <h2>๐งช ุตูุญุฉ ุงูุฎูุทุงุช</h2>
    <p class="small">
        ุงูุฎูุทุฉ ูู ูุฌููุนุฉ ููุงุฏ ูู ุงููุฎุฒูู ุชูุณุชุฎุฏู ูุงุญูุงู ูู ุงูููุชุฌุงุช ุงูููุงุฆูุฉ ุจูููุงุช ุฌุฒุฆูุฉ.
        <br/>
        **ููุงุญุธุฉ:** ูุชู ุญุณุงุจ ุชูููุฉ ุงูุฎูุทุฉ ุจูุงุกู ุนูู **ุณุนุฑ ุงููุญุฏุฉ ุงูุฃุณุงุณูุฉ ุงูุญุงูู** ูู ุตูุญุฉ ุงูุชุนุฑูู/ุงููุดุชุฑูุงุช.
    </p>
    <div class="btn-row">
        <button class="secondary" onclick="addMixBlock()">+ ุฅุถุงูุฉ ุฎูุทุฉ ุฌุฏูุฏุฉ</button>
    </div>
    <div id="mixesContainer"></div>

    <h3 style="margin-top:18px;font-size:15px;">โ๏ธ ุชุนุฑูู ูุฒู ูู ุฎูุทุฉ</h3>
    <table class="summary-table" id="mixSummary">
        <tr>
            <th>ุงุณู ุงูุฎูุทุฉ</th>
            <th>ุฅุฌูุงูู ุชูููุฉ ุงูุฎูุทุฉ (ุฑูุงู)</th>
            <th>ุฅุฌูุงูู ุงููุฒู</th>
            <th>ุงููุญุฏุฉ</th>
            <th>ุชูููุฉ ุงููุญุฏุฉ (ุฑูุงู / ูู ุฃู ุฌุฑุงู)</th>
        </tr>
    </table>
</div>

<div class="page" id="pageProd">
    <h2>โ ุตูุญุฉ ุงูููุชุฌุงุช / ุงููุตูุงุช</h2>
    <p class="small">
        โ ููู ููุชุฌุ ุฃุฏุฎู ููููุงุชู ูุชูููุฉ ุตูุนูุ ุจุงูุฅุถุงูุฉ ุฅูู **ุณุนุฑ ุงูุจูุน ููุนููู**.
    </p>
    <div class="btn-row">
        <button class="secondary" onclick="addProductBlock()">+ ุฅุถุงูุฉ ููุชุฌ ุฌุฏูุฏ</button>
        <button class="secondary" onclick="exportData()">๐พ ุญูุธ ุงูุจูุงูุงุช ูููู</button>
        <button class="secondary" onclick="document.getElementById('fileInput').click()">๐ ุงุณุชุนุงุฏุฉ ูู ููู</button>
        <button class="secondary" onclick="exportPDF()">๐จ๏ธ ุชูุฑูุฑ ุชูุตููู ูููุชุฌ (PDF)</button>
        <button class="secondary" onclick="exportComprehensivePDF()">๐ ุชูุฑูุฑ ุดุงูู ููููุฎุตุงุช (PDF)</button>
    </div>
    <div id="productsContainer"></div>
    <h3 style="margin-top:18px;">๐ ููุฎุต ุชูููุฉ ูุฑุจุญูุฉ ูู ููุชุฌ</h3>
    <table class="summary-table" id="productSummary">
        <tr><th>ุงุณู ุงูููุชุฌ</th><th>ุณุนุฑ ุงูุจูุน</th><th>ุฅุฌูุงูู ุงูุชูููุฉ (ุฑูุงู)</th><th>ุงูุฑุจุญ (ุฑูุงู)</th><th>ูุณุจุฉ ุงูุฑุจุญ (%)</th></tr>
    </table>
    <h3 style="margin-top:18px;">ุฅุฌูุงูู ุชูููุฉ ูู ุงูููุชุฌุงุช ุงูุตุงูุญุฉ: <span id="total">0.00</span> ุฑูุงู</h3>
    <input accept=".json" id="fileInput" style="display:none" type="file">
</div>

<div class="page" id="pagePurchases">
    <h2>๐ ุตูุญุฉ ุงููุดุชุฑูุงุช ูุงูููุงุชูุฑ</h2>
    <p class="small">
        ูู ุจุชุณุฌูู ุชูุงุตูู ููุงุชูุฑ ุงููุดุชุฑูุงุช. ูุชู ุชุญุฏูุซ ุณุนุฑ ุงููุญุฏุฉ ุงูุฃุณุงุณูุฉ ูููุงุฏุฉ ูู ุงููุธุงู ุจูุงุกู ุนูู ุขุฎุฑ ุณุนุฑ ุดุฑุงุก.
        <br/>
        **ููุงุญุธุฉ:** ุณูุชู ุฅุถุงูุฉ ูุฐู ุงููููุงุช ุฅูู ูุณุชููุงุช ุงููุฎุฒูู ุนูุฏ ุงูุญุณุงุจ.
    </p>

    <div class="btn-row">
        <button class="secondary" onclick="addPurchaseBlock()">+ ุฅุถุงูุฉ ูุงุชูุฑุฉ ูุดุชุฑูุงุช ุฌุฏูุฏุฉ</button>
    </div>
    <div id="purchasesContainer"></div>

    <h3 style="margin-top:18px;">ุฅุฌูุงูู ุงููุดุชุฑูุงุช ุงููุณุฌูุฉ: <span id="purchasesTotal">0.00</span> ุฑูุงู</h3>
</div>

<div class="page" id="pageWaste">
    <h2>๐๏ธ ุตูุญุฉ ุงููุฏุฑ ูุงููุงูุฏ ุงููุณุฌู</h2>
    <p class="small">
        ุณุฌู ุงููููุงุช ุงูุชู ุชู ุฅูุฏุงุฑูุง (ุฎุฑุจุชุ ุทุงุญุชุ ุฅูุฎ). ุณูุชู ุฎุตููุง ูู ูุณุชููุงุช ุงููุฎุฒูู.
        <br/>
        **ุงููุฏุฑ ูู ุงูููุชุฌุงุช:** ุนูุฏ ุฅุฏุฎุงู ููุชุฌ ุถุงุฆุนุ ุณูุชู ุชุญูููู ุชููุงุฆูุงู ุฅูู ุงุณุชููุงู ูู ููุงุฏู ุงูุฎุงู.
    </p>
    <div class="card">
        <div class="btn-row">
            <button class="secondary" onclick="addWasteRow()">+ ุฅุถุงูุฉ ุณุทุฑ ูุฏุฑ</button>
            <button class="action" onclick="calcWaste()">ุญุณุงุจ ุงููุฏุฑ ูุงูุฎุตู</button>
        </div>
        <table id="wasteTbl">
            <tr>
                <th>ุงูููุน</th>
                <th>ุงูุงุณู (ูุงุฏุฉ ุฃู ููุชุฌ)</th>
                <th>ุงููููุฉ</th>
                <th>ุงูุชูููุฉ ุงูุชูุฑูุจูุฉ</th>
                <th>ุญุฐู</th>
            </tr>
        </table>
    </div>
    <div class="card">
        <h3>ููุฎุต ุงููุฏุฑ ุงูุฅุฌูุงูู (ุจุงููุญุฏุฉ ุงูุฃุณุงุณูุฉ ูุงูุชูููุฉ)</h3>
        <table id="wasteSummary">
            <tr>
                <th>ุงุณู ุงููุงุฏุฉ</th>
                <th>ุงููููุฉ ุงูููุฏุฑุฉ (ูุญุฏุฉ ุฃุณุงุณูุฉ)</th>
                <th>ุงูุชูููุฉ ุงูุฅุฌูุงููุฉ (ุฑูุงู)</th>
            </tr>
        </table>
        <h3 style="color:#f97316;">ุฅุฌูุงูู ุชูููุฉ ุงููุฏุฑ ุงููุณุฌู: <span id="totalWasteCost">0.00</span> ุฑูุงู</h3>
    </div>
</div>

<div class="page" id="pageSales">
    <h2>๐ ุตูุญุฉ ุงููุจูุนุงุช ูุงุณุชููุงู ุงูููุงุฏ</h2>
    <p class="small">
        โ ุฃุฏุฎู ุงุณู ุงูููุชุฌ ูุนุฏุฏ ุงูุทูุจุงุช ุงููุจูุนุฉ ููุฐุง ุงูุดูุฑ.
        <br/>
        **ูุฐู ุงูุจูุงูุงุช ุถุฑูุฑูุฉ ูุชูุฑูุฑ ุงูุฌุฑุฏ ูุงูููุงุฑูุฉ.**
    </p>
    <div class="card">
        <div class="btn-row">
            <button class="secondary" onclick="addSalesRow()">+ ุฅุถุงูุฉ ุณุทุฑ ูุจูุนุงุช</button>
            <button class="secondary" onclick="clearSalesRows()">ูุณุญ ูู ุงูุณุทูุฑ</button>
            <button class="action" onclick="calcSales()">ุญุณุงุจ ุงููุจูุนุงุช ูุงูุงุณุชููุงู ุงููุธุฑู</button>
        </div>
        <table id="salesTbl">
            <tr>
                <th>ุงุณู ุงูููุชุฌ</th>
                <th>ุนุฏุฏ ุงูุทูุจุงุช / ุงูุฃููุงุจ</th>
                <th>ููุงุญุธุฉ</th>
                <th>ุญุฐู</th>
            </tr>
        </table>
    </div>
    <div class="card">
        <h3 style="color:#f97316;">ุฅุฌูุงูู ุฅูุฑุงุฏุงุช ุงููุจูุนุงุช (ุงููุทุงุจูุฉ): <span id="totalSalesRevenue">0.00</span> ุฑูุงู</h3>
        <h3>ููุฎุต ุงุณุชููุงู ุงูููุงุฏ ุงููุธุฑู ูู ุงููุจูุนุงุช (COGS)</h3>
        <table id="salesSummary">
            <tr>
                <th>ุงุณู ุงููุงุฏุฉ</th>
                <th>ุงููููุฉ ุงููุณุชูููุฉ (ูุญุฏุฉ ุฃุณุงุณูุฉ)</th>
                <th>ุงูุชูููุฉ ุงูุฅุฌูุงููุฉ (ุฑูุงู)</th>
            </tr>
        </table>
    </div>
</div>

<div class="page" id="pageInvLevels">
    <h2>๐ ูุณุชููุงุช ุงููุฎุฒูู ูุงูุฑุตูุฏ ุงูุญุงูู</h2>
    <p class="small">
        **ุฑุตูุฏ ุฃูู ุงููุฏุฉ (BB):** ุณุฌู ุงููููุฉ ุงูุฃูููุฉ ุงูููุฌูุฏุฉ ูู ุจุฏุงูุฉ ุงููุชุฑุฉ.
        <br/>
        **ุงูุฑุตูุฏ ุงูุญุงูู:** ูุชู ุญุณุงุจู ุชููุงุฆูุงู ุจูุงุกู ุนูู: (BB + ุงููุดุชุฑูุงุช - ุงููุจูุนุงุช - ุงููุฏุฑ).
    </p>

    <h3 style="margin-top: 15px;">ุฅุฏุฎุงู ุฑุตูุฏ ุฃูู ุงููุฏุฉ (BB)</h3>
    <div class="btn-row">
        <button class="secondary" onclick="addBBRow()">+ ุฅุถุงูุฉ ุณุทุฑ BB</button>
        <button class="action" onclick="calculateInventoryLevels()">ุญุณุงุจ ูุณุชููุงุช ุงููุฎุฒูู</button>
    </div>
    <table id="bbTbl">
        <tr><th>ุงุณู ุงููุงุฏุฉ (ุจุญุซ)</th><th>BB ุงููููุฉ (ูุญุฏุฉ ุงูุดุฑุงุก)</th><th>BB ุงูุณุนุฑ ุงูุฅุฌูุงูู</th><th>ุญุฐู</th></tr>
    </table>

    <h3 style="margin-top: 25px; color:#f97316;">ุฌุฏูู ูุณุชููุงุช ุงููุฎุฒูู ุงูุญุงูู (ูู ุฃู ูุญุธุฉ)</h3>
    <table id="currentInvTbl">
        <tr>
            <th>ุงููุงุฏุฉ</th>
            <th>ุงููุญุฏุฉ ุงูุฃุณุงุณูุฉ</th>
            <th>BB ุงููููุฉ</th>
            <th>ูุดุชุฑูุงุช ุงููููุฉ</th>
            <th>ุงุณุชููุงู (ูุจูุนุงุช + ูุฏุฑ)</th>
            <th>ุงูุฑุตูุฏ ุงูุญุงูู (ุงููุชููุฑ ูุธุฑูุงู)</th>
        </tr>
    </table>
</div>

<div class="page" id="pageVariance">
    <h2>โ๏ธ ุชูุฑูุฑ ุงูุฌุฑุฏ ูุงูููุงุฑูุฉ (ุดูุฑุช/ุฃููุฑ)</h2>
    <p class="small">
        **ุงูุงุณุชุฎุฏุงู ุงููุธุฑู = ุงุณุชููุงู ุงููุจูุนุงุช + ุงููุฏุฑ ุงููุณุฌู.**
        <br/>
        **ุงูุงุณุชุฎุฏุงู ุงููุนูู = (ุฑุตูุฏ ุฃูู ุงููุฏุฉ + ุงููุดุชุฑูุงุช) - ุฑุตูุฏ ุขุฎุฑ ุงููุฏุฉ.**
        <br/>
        **ุงููุฏุฑ ุบูุฑ ุงููุณุฌู = ุงูุงุณุชุฎุฏุงู ุงููุนูู - ุงูุงุณุชุฎุฏุงู ุงููุธุฑู.** (ูููุฉ ุณุงูุจุฉ ุชุนูู ุดูุฑุช ุฅุถุงููุ ููุฌุจุฉ ุชุนูู ุฃููุฑ).
    </p>
    <h3 style="color:#f97316;">ุงูุฎุทูุฉ ุงูุฃููู: ุฅุฏุฎุงู ุฑุตูุฏ ุขุฎุฑ ุงููุฏุฉ (EB)</h3>
    <p class="small">ุฃุฏุฎู ูููุฉ ูููุงูุฉ ุงูุฑุตูุฏ ููู ูุงุฏุฉ ุฌุฑุฏุชูุง ูุฏููุงู.</p>
    <div class="btn-row">
        <button class="secondary" onclick="addEBRow()">+ ุฅุถุงูุฉ ุณุทุฑ ุฑุตูุฏ ุขุฎุฑ ุงููุฏุฉ</button>
    </div>
    <table id="ebTbl">
        <tr><th>ุงุณู ุงููุงุฏุฉ (ุจุญุซ)</th><th>EB ุงููููุฉ (ูุญุฏุฉ ุงูุดุฑุงุก)</th><th>EB ุงูุณุนุฑ ุงูุฅุฌูุงูู</th><th>ุญุฐู</th></tr>
    </table>

    <div class="btn-row" style="margin-top: 20px;">
        <button class="action" onclick="calculateVariance()">ุฅุฌุฑุงุก ุงูุฌุฑุฏ ูุงูููุงุฑูุฉ</button>
    </div>

    <h3 style="color:#f97316; margin-top: 25px;">ูุชุงุฆุฌ ุงูุฌุฑุฏ ูุงูููุงุฑูุฉ (ุงููุฏุฑ ุบูุฑ ุงููุณุฌู)</h3>
    <p class="small">ุงููููุฉ ุงูุณุงูุจุฉ **(ููู ุฃุญูุฑ)** ุชุนูู **ุดูุฑุช ุบูุฑ ูุณุฌู**ุ ูุงููููุฉ ุงูููุฌุจุฉ **(ููู ุฃุฎุถุฑ)** ุชุนูู **ุฃููุฑ**.</p>
    <table id="varianceTbl">
        <tr>
            <th>ุงููุงุฏุฉ</th>
            <th>ุงูุงุณุชุฎุฏุงู ุงููุธุฑู</th>
            <th>ุงูุงุณุชุฎุฏุงู ุงููุนูู</th>
            <th>ุงููุฏุฑ ุบูุฑ ุงููุณุฌู (ุงููููุฉ)</th>
            <th>ุชูููุฉ ุงููุฏุฑ ุบูุฑ ุงููุณุฌู (ุฑูุงู)</th>
        </tr>
    </table>
</div>


<datalist id="ingList"></datalist>
<datalist id="mixList"></datalist>
<datalist id="prodList"></datalist>
<datalist id="ingProdList"></datalist>
<datalist id="salesProdList"></datalist>
<datalist id="bbIngList"></datalist>
<datalist id="ebIngList"></datalist>
<datalist id="purchaseIngList"></datalist>
<script>
let ing = [];   // ุชุนุฑูู ุงูููุงุฏ: {n, basePrice, baseUnit}
let mixes = []; // ุงูุฎูุทุงุช
let purchases = []; // ููุงุชูุฑ ุงููุดุชุฑูุงุช
let bbData = []; // ุฑุตูุฏ ุฃูู ุงููุฏุฉ
let ebData = []; // ุฑุตูุฏ ุขุฎุฑ ุงููุฏุฉ
let wasteData = []; // ุงููุฏุฑ ุงููุณุฌู
let salesData = []; // ุงููุจูุนุงุช

let salesUsage = {}; // ุงูุงุณุชููุงู ุงููุธุฑู ูู ุงููุจูุนุงุช
let wasteUsage = {}; // ุงูุงุณุชููุงู ุงููุธุฑู ูู ุงููุฏุฑ
let productsData = {}; // ูุชุฎุฒูู ุจูุงูุงุช ุงูููุชุฌุงุช (ุณุนุฑ ุจูุนุ ุชูููุฉ)

/************ ุงูุฏูุงู ุงููุณุงุนุฏุฉ ************/
function convertToBaseUnit(qty, unit) {
    if(unit === 'kg') return {qty: qty * 1000, unit: 'g'};
    if(unit === 'l') return {qty: qty * 1000, unit: 'ml'};
    if(unit === 'g') return {qty: qty, unit: 'g'};
    if(unit === 'ml') return {qty: qty, unit: 'ml'};
    return {qty: qty, unit: 'pc'};
}
function getMaterialUnit(name) {
    const item = ing.find(i => i.n === name);
    return item ? item.baseUnit : '';
}
function getMaterialPrice(name) {
    const item = ing.find(i => i.n === name);
    return item ? item.basePrice : 0;
}
function getProductInfo(name) {
    return productsData[name];
}
function getMixCostPerUnit(name) {
    const mix = mixes.find(m => m.name === name);
    if (!mix || !mix.totalWeight || mix.totalWeight <= 0) return 0;
    return mix.totalCost / mix.totalWeight;
}

/************ ุงูุชููู ุจูู ุงูุตูุญุงุช ************/
function showPage(which){
    const pages = ['def', 'mix', 'prod', 'purchases', 'waste', 'sales', 'invlevels', 'variance'];
    pages.forEach(p => {
        const page = document.getElementById('page' + p.charAt(0).toUpperCase() + p.slice(1));
        const btn = document.getElementById('btn' + p.charAt(0).toUpperCase() + p.slice(1));
        if (page) page.classList.remove('active');
        if (btn) { btn.classList.add('inactive'); btn.classList.remove('active'); }
    });

    const page = document.getElementById('page' + which.charAt(0).toUpperCase() + which.slice(1));
    const btn = document.getElementById('btn' + which.charAt(0).toUpperCase() + which.slice(1));
    if (page) page.classList.add('active');
    if (btn) { btn.classList.add('active'); btn.classList.remove('inactive'); }

    // ุฅุฌุฑุงุก ุชุญุฏูุซุงุช ุถุฑูุฑูุฉ ุนูุฏ ุงูุชููู
    if (which === 'mix') recalcMixes();
    if (which === 'prod') calcProducts();
    if (which === 'purchases') recalcPurchases();
    if (which === 'waste') calcWaste();
    if (which === 'sales') calcSales();
    if (which === 'invlevels') calculateInventoryLevels();
    if (which === 'variance') calculateVariance();
}

/************ ุตูุญุฉ ุชุนุฑูู ุงูููุงุฏ ุงูุฃุณุงุณูุฉ (Def) ************/
function addIngredientDef(){
    const n = document.getElementById('defName').value.trim();
    const u = document.getElementById('defUnit').value;
    const q = parseFloat(document.getElementById('defQty').value);
    const p = parseFloat(document.getElementById('defPrice').value);

    if(!n || !q || !p || q<=0 || p<=0){
        alert('ุฃุฏุฎู ุงูุงุณู ูุงููููุฉ ูุงูุณุนุฑ ุจุดูู ุตุญูุญ (ูุฌุจ ุฃู ุชููู ุงููููุฉ ูุงูุณุนุฑ ุฃูุจุฑ ูู ุตูุฑ).');
        return;
    }

    const {qty: baseQty, unit: baseUnit} = convertToBaseUnit(q, u);
    const basePrice = p / baseQty;

    const existingIndex = ing.findIndex(i => i.n === n);
    if(existingIndex !== -1){
        if(!confirm(`ุงููุงุฏุฉ "${n}" ููุฌูุฏุฉ. ูู ุชุฑูุฏ ุชุญุฏูุซ ุณุนุฑ ุงููุญุฏุฉ ุงูุฃุณุงุณูุฉ ููุงุ`)) return;
        ing[existingIndex].basePrice = basePrice;
        ing[existingIndex].baseUnit = baseUnit;
    } else {
        ing.push({n, basePrice, baseUnit});
    }

    renderDefTbl();
    updateAllLookupsAndUnits();
    recalcMixes(); // ูุฅุนุงุฏุฉ ุญุณุงุจ ุงูุชูููุฉ ุจูุงุกู ุนูู ุงูุณุนุฑ ุงูุฌุฏูุฏ
    calcProducts(); // ูุฅุนุงุฏุฉ ุญุณุงุจ ุงูุชูููุฉ ุจูุงุกู ุนูู ุงูุณุนุฑ ุงูุฌุฏูุฏ
    
    document.getElementById('defName').value = document.getElementById('defQty').value = document.getElementById('defPrice').value = '';
}

function renderDefTbl(){
    const tbl = document.getElementById('defTbl');
    let header = '<tr><th>ุงููุงุฏุฉ</th><th>ุงููุญุฏุฉ ุงูุฃุณุงุณูุฉ</th><th>ุณุนุฑ ุงููุญุฏุฉ ุงูุฃุณุงุณูุฉ ุงูุญุงูู</th><th>ุญุฐู</th></tr>';
    let rows = ing.map((i,idx) => {
        let label = i.baseUnit;
        if(label === 'g') label = 'ุฌุฑุงู (g)';
        else if(label === 'ml') label = 'ูู (ml)';
        else if(label === 'pc') label = 'ุญุจุฉ (Pc)';
        
        return `
        <tr>
            <td>${i.n}</td>
            <td>${label}</td>
            <td>${i.basePrice.toFixed(4)} ุฑูุงู / ${i.baseUnit}</td>
            <td><button class="secondary" onclick="deleteIngredientDef(${idx})">ุญุฐู</button></td>
        </tr>`;
    }).join('');
    tbl.innerHTML = header + rows;
}

function deleteIngredientDef(index){
    if(!confirm('ุญุฐู ูุฐู ุงููุงุฏุฉ ุณูุคุซุฑ ุนูู ูู ุงููุธุงู. ูู ุฃูุช ูุชุฃูุฏุ')) return;
    const materialName = ing[index].n;
    ing.splice(index,1);
    
    // ุชูุธูู ุงูุจูุงูุงุช ุงููุชุนููุฉ
    bbData = bbData.filter(i => i.name !== materialName);
    ebData = ebData.filter(i => i.name !== materialName);
    wasteData = wasteData.filter(i => i.name !== materialName || i.type === 'product'); // ุฅุจูุงุก ุงูููุชุฌุงุช
    purchases.forEach(p => { p.items = p.items.filter(item => item.name !== materialName); });
    purchases = purchases.filter(p => p.items.length > 0);
    
    renderDefTbl();
    updateAllLookupsAndUnits();
    recalcPurchases();
    recalcMixes();
    calcProducts();
    calcWaste();
    calcSales();
}

/************ ููุงุฆู ุงูุจุญุซ (datalist) ************/
function updateLookups(){
    const lists = ['ingList', 'mixList', 'prodList', 'ingProdList', 'salesProdList', 'bbIngList', 'ebIngList', 'purchaseIngList'];
    lists.forEach(id => {
        const el = document.getElementById(id);
        if(el) el.innerHTML = '';
    });

    ing.forEach(i=>{
        const opt = document.createElement('option');
        opt.value = i.n;
        ['ingList', 'ingProdList', 'bbIngList', 'ebIngList', 'purchaseIngList'].forEach(id => {
            const el = document.getElementById(id);
            if(el) el.appendChild(opt.cloneNode(true));
        });
    });

    mixes.forEach(m=>{
        if(m.totalCost > 0){
            const opt = document.createElement('option');
            opt.value = m.name;
            document.getElementById('mixList')?.appendChild(opt);
        }
    });

    Object.keys(productsData).forEach(n=>{
        const opt = document.createElement('option');
        opt.value = n;
        ['prodList', 'ingProdList', 'salesProdList'].forEach(id => {
            const el = document.getElementById(id);
            if(el) el.appendChild(opt.cloneNode(true));
        });
    });
}
function updateAllLookupsAndUnits(){
    updateLookups();
    // ูุฌุจ ุชุญุฏูุซ ุงูู unit label ูู ุฌููุน ุงูุตูุญุงุช ุฐุงุช ุงูุตูุฉ
    const prodBlocks = document.querySelectorAll('.product-block');
    prodBlocks.forEach(block=>{
        const rows = block.querySelectorAll('table tr');
        rows.forEach((tr,idx)=>{
            if(idx===0) return;
            updateRowUnit(tr);
        });
    });
}
// ... (ุจููุฉ ุฏูุงู updateRowUnit, onTypeChangeRow, updateNameInputList, onNameInput ูู ูุชู ุชุนุฏูููุง ุฌููุฑููุง)


/************ ุฏูุงู ุตูุญุฉ ุงููุดุชุฑูุงุช (Purchases) ************/
// ... (addPurchaseBlock, deletePurchaseBlock, addPurchaseItemRow, deletePurchaseItemRow)
function recalcPurchases(){
    const purchaseBlocks = document.querySelectorAll('#purchasesContainer .mix-block');
    purchases = [];
    let grandTotalPurchases = 0;

    purchaseBlocks.forEach(block => {
        const supplier = block.querySelector('.purchase-supplier').value.trim();
        const date = block.querySelector('.purchase-date').value;
        const totalCostSpan = block.querySelector('.purchase-total-cost');
        const rows = block.querySelectorAll('table tr');

        let invoiceTotal = 0;
        let invoiceItems = [];
        let invoiceHasError = false;

        rows.forEach((tr, idx) => {
            if(idx === 0) return;
            const name = (tr.querySelector('.purchase-name-input').value || '').trim();
            const unit = tr.querySelector('.purchase-unit-select').value;
            const qty = parseFloat(tr.querySelector('.purchase-qty-input').value) || 0;
            const price = parseFloat(tr.querySelector('.purchase-price-input').value) || 0;

            if(name && qty > 0 && price > 0){
                invoiceItems.push({name, unit, qty, price});
                invoiceTotal += price;

                // **ุชุญุฏูุซ ุณุนุฑ ุงููุญุฏุฉ ุงูุฃุณุงุณูุฉ ูู ุงููุฎุฒูู (ing) ุจูุงุกู ุนูู ุขุฎุฑ ุดุฑุงุก**
                const {qty: baseQty, unit: baseUnit} = convertToBaseUnit(qty, unit);
                const basePrice = price / baseQty;
                const ingIndex = ing.findIndex(i => i.n === name);
                if(ingIndex !== -1){
                    ing[ingIndex].basePrice = basePrice;
                } else {
                    // ุฅุฐุง ูู ุชูู ุงููุงุฏุฉ ูุนุฑูุฉุ ูุชู ุชุนุฑูููุง ุงูุขู
                    ing.push({n: name, basePrice, baseUnit});
                }
            } else if (name || qty > 0 || price > 0) {
                invoiceHasError = true;
            }
        });

        if(supplier && date && invoiceItems.length > 0 && !invoiceHasError){
            purchases.push({supplier, date, items: invoiceItems, totalCost: invoiceTotal});
            grandTotalPurchases += invoiceTotal;
            totalCostSpan.textContent = invoiceTotal.toFixed(2);
        } else {
            totalCostSpan.textContent = 'ุฎุทุฃ/ุจูุงูุงุช ุบูุฑ ููุชููุฉ';
        }
    });

    document.getElementById('purchasesTotal').textContent = grandTotalPurchases.toFixed(2);

    renderDefTbl(); // ุชุญุฏูุซ ุฌุฏูู ุงูุชุนุฑูู ููุนูุณ ุงูุฃุณุนุงุฑ ุงูุฌุฏูุฏุฉ
    updateAllLookupsAndUnits();
    recalcMixes();
    calcProducts();
}

/************ ุฏูุงู ุตูุญุฉ ุงูุฎูุทุงุช (Mixes) ************/
// ... (ุฏูุงู ุงูุฎูุทุงุช ุชุนุชูุฏ ุนูู getMaterialPrice)

/************ ุฏูุงู ุตูุญุฉ ุงูููุชุฌุงุช (Products) ************/
// ... (ุฏูุงู ุงูููุชุฌุงุช ุชุนุชูุฏ ุนูู getMaterialPrice ู getMixCostPerUnit)

/************ ุฏูุงู ุตูุญุฉ ุงููุฏุฑ ูุงููุงูุฏ (Waste) ************/
function addWasteRow(wasteDataRow){
    const tbl = document.getElementById('wasteTbl');
    if(!tbl) return;
    const tr = document.createElement('tr');
    const typeVal = wasteDataRow ? wasteDataRow.type : 'material';
    const nameVal = wasteDataRow ? wasteDataRow.name : '';
    const qtyVal = wasteDataRow ? wasteDataRow.qty : '';

    tr.innerHTML = `
        <td>
            <select class="waste-type-select" onchange="updateWasteList(this)">
                <option value="material" ${typeVal === 'material' ? 'selected' : ''}>ูุงุฏุฉ ุฎุงู</option>
                <option value="product" ${typeVal === 'product' ? 'selected' : ''}>ููุชุฌ ููุงุฆู</option>
            </select>
        </td>
        <td>
            <input class="waste-name-input" placeholder="ุงูุชุจ ุงุณู ุงููุงุฏุฉ/ุงูููุชุฌ" list="${typeVal === 'material' ? 'ingList' : 'prodList'}" value="${nameVal || ''}" oninput="calcWaste()">
        </td>
        <td>
            <input type="number" class="waste-qty-input" value="${qtyVal || ''}" oninput="calcWaste()">
        </td>
        <td class="waste-cost-cell">0.00</td>
        <td><button class="secondary" onclick="deleteWasteRow(this)">ุญุฐู</button></td>
    `;
    tbl.appendChild(tr);
}

function deleteWasteRow(btn){
    const tr = btn.closest('tr');
    tr.parentNode.removeChild(tr);
    calcWaste();
}

function updateWasteList(sel){
    const tr = sel.closest('tr');
    const nameInput = tr.querySelector('.waste-name-input');
    if(sel.value === 'material'){
        nameInput.setAttribute('list', 'ingList');
    } else {
        nameInput.setAttribute('list', 'prodList');
    }
    nameInput.value = ''; // ูุณุญ ุงูุงุณู ูุชุฌูุจ ุฃุฎุทุงุก ุงูุจุญุซ
    calcWaste();
}

function calcWaste(){
    const tbl = document.getElementById('wasteTbl');
    if(!tbl) return;
    const rows = Array.from(tbl.querySelectorAll('tr')).slice(1);
    
    // ุฅุนุงุฏุฉ ุจูุงุก ูุตูููุฉ wasteData
    wasteData = [];
    rows.forEach(tr => {
        const type = tr.querySelector('.waste-type-select').value;
        const name = (tr.querySelector('.waste-name-input').value || '').trim();
        const qty = parseFloat(tr.querySelector('.waste-qty-input').value) || 0;
        
        if(name && qty > 0){
            wasteData.push({type, name, qty});
        }
    });

    // ุญุณุงุจ ุงูุงุณุชููุงู ุงููุธุฑู ูููุฏุฑ (wasteUsage)
    wasteUsage = {};
    let totalWasteCost = 0;

    wasteData.forEach((w, idx) => {
        const tr = tbl.querySelectorAll('tr')[idx + 1];
        const costCell = tr.querySelector('.waste-cost-cell');
        let wasteCost = 0;
        
        if(w.type === 'material'){
            const material = ing.find(i => i.n === w.name);
            if(material){
                const {qty: baseQty} = convertToBaseUnit(w.qty, material.baseUnit); // ูุณุชุฎุฏู ูุญุฏุฉ ุงูุชุนุฑูู ููุญุฏุฉ ุดุฑุงุก ุงูุชุฑุงุถูุฉ
                wasteCost = baseQty * material.basePrice;
                
                if(!wasteUsage[w.name]) wasteUsage[w.name] = {qty: 0, cost: 0, unit: material.baseUnit};
                wasteUsage[w.name].qty += baseQty;
                wasteUsage[w.name].cost += wasteCost;
            }
        } else if (w.type === 'product'){
            const prod = productsData[w.name];
            if(prod){
                wasteCost = prod.totalCost * w.qty;
                totalWasteCost += wasteCost;
                
                // ุชุญููู ุงูููุชุฌ ุฅูู ููุงุฏ ุฎุงู ููุฏุฑุฉ
                const prodBlock = Array.from(document.querySelectorAll('.product-block')).find(b => b.querySelector('.prod-name').value.trim() === w.name);
                if(prodBlock && !prodBlock.classList.contains('bad')){
                    // ููุง ููุฑุฑ ููุทู calcSales ูุชูุณูุน ุงูููุชุฌ ุฅูู ููุงุฏ ุฎุงู
                    const rowsProd = prodBlock.querySelectorAll('table tr');
                    rowsProd.forEach((trItem, rIdx)=>{
                        if(rIdx === 0 || trItem.classList.contains('bad')) return;
                        const typeSel = trItem.querySelector('.typeSelect');
                        const nameInput = trItem.querySelector('.nameInput');
                        const qtyInputRow = trItem.querySelector('td:nth-child(3) input');

                        const typeVal = typeSel.value;
                        const name = (nameInput.value || '').trim();
                        const qtyPerUnit = parseFloat(qtyInputRow.value || '0') || 0;

                        if(typeVal === 'ing'){
                            const ingItem = ing.find(i=>i.n === name);
                            if(ingItem){
                                if(!wasteUsage[name]) wasteUsage[name] = {qty: 0, cost: 0, unit: ingItem.baseUnit};
                                const consumedQty = qtyPerUnit * w.qty;
                                wasteUsage[name].qty += consumedQty;
                                wasteUsage[name].cost += consumedQty * ingItem.basePrice;
                            }
                        } else if(typeVal === 'mix'){
                            // ... (ุชูุณุนุฉ ุงูุฎูุทุฉ - ููุณ ููุทู calcSales)
                        }
                    });
                }
            }
        }
        
        costCell.textContent = wasteCost.toFixed(2);
        totalWasteCost += wasteCost;
    });

    // ุนุฑุถ ููุฎุต ุงููุฏุฑ
    const sumTbl = document.getElementById('wasteSummary');
    let header = '<tr><th>ุงุณู ุงููุงุฏุฉ</th><th>ุงููููุฉ ุงูููุฏุฑุฉ (ูุญุฏุฉ ุฃุณุงุณูุฉ)</th><th>ุงูุชูููุฉ ุงูุฅุฌูุงููุฉ (ุฑูุงู)</th></tr>';
    let rowsHtml = '';
    Object.keys(wasteUsage).sort().forEach(n => {
        const u = wasteUsage[n];
        let label = u.unit === 'g' ? 'ุฌุฑุงู' : (u.unit === 'ml' ? 'ูู' : 'ุญุจุฉ');
        rowsHtml += `<tr><td>${n}</td><td>${u.qty.toFixed(2)} ${label}</td><td>${u.cost.toFixed(2)}</td></tr>`;
    });
    
    sumTbl.innerHTML = header + rowsHtml;
    document.getElementById('totalWasteCost').textContent = totalWasteCost.toFixed(2);

    calculateInventoryLevels(); // ุชุญุฏูุซ ูุณุชููุงุช ุงููุฎุฒูู
}

/************ ุฏูุงู ุตูุญุฉ ุงููุจูุนุงุช (Sales) ************/
// ... (addSalesRow, deleteSalesRow, clearSalesRows)
// ... (calcSales - ูุญุชุงุฌ ุชุญุฏูุซ ูุงุณุชุฎุฏุงู getProductInfo ู productsData)

/************ ุฏูุงู ุตูุญุฉ ูุณุชููุงุช ุงููุฎุฒูู (Inventory Levels) ************/
function addBBRow(bbDataRow){
    const tbl = document.getElementById('bbTbl');
    if(!tbl) return;
    const tr = document.createElement('tr');
    const nameVal = bbDataRow ? bbDataRow.name : '';
    const qtyVal = bbDataRow ? bbDataRow.qty : '';
    const priceVal = bbDataRow ? bbDataRow.cost : '';

    tr.innerHTML = `
        <td>
            <input class="bb-name-input" placeholder="ุงูุชุจ ุงุณู ุงููุงุฏุฉ ูุงุฎุชุฑูุง" list="bbIngList" value="${nameVal || ''}" oninput="/* ูุง ุดูุก */">
        </td>
        <td>
            <input type="number" class="bb-qty-input" value="${qtyVal || ''}" oninput="/* ูุง ุดูุก */">
        </td>
        <td>
            <input type="number" class="bb-price-input" value="${priceVal || ''}" oninput="/* ูุง ุดูุก */">
        </td>
        <td><button class="secondary" onclick="deleteBBRow(this)">ุญุฐู</button></td>
    `;
    tbl.appendChild(tr);
}
function deleteBBRow(btn){
    const tr = btn.closest('tr');
    tr.parentNode.removeChild(tr);
}

function calculateInventoryLevels(){
    // 1. ุชุฌููุน ุฑุตูุฏ ุฃูู ุงููุฏุฉ (BB)
    bbData = [];
    document.querySelectorAll('#bbTbl tr').forEach((tr, idx) => {
        if(idx === 0) return;
        const name = (tr.querySelector('.bb-name-input').value || '').trim();
        const qty = parseFloat(tr.querySelector('.bb-qty-input').value) || 0;
        const cost = parseFloat(tr.querySelector('.bb-price-input').value) || 0;

        const material = ing.find(i => i.n === name);
        if(material && qty > 0 && cost >= 0){
            const {qty: baseQty} = convertToBaseUnit(qty, material.baseUnit); // ููุชุฑุถ ุฃู ุงููุญุฏุฉ ุงููุฏุฎูุฉ ูู ูุญุฏุฉ ุชุนุฑูู ุงููุงุฏุฉ
            bbData.push({name, qty: baseQty, cost});
        }
    });

    // 2. ุชุฌููุน ูููุงุช ุงููุดุชุฑูุงุช
    const purchaseTotals = {}; // {name: {qty: totalQty, cost: totalCost}}
    purchases.forEach(p => {
        p.items.forEach(item => {
            const {qty: baseQty} = convertToBaseUnit(item.qty, item.unit);
            if(!purchaseTotals[item.name]) purchaseTotals[item.name] = {qty: 0, cost: 0};
            purchaseTotals[item.name].qty += baseQty;
            purchaseTotals[item.name].cost += item.price;
        });
    });

    // 3. ุชุฌููุน ุงูุงุณุชููุงู (ูุจูุนุงุช + ูุฏุฑ)
    const consumptionTotals = {};
    const consolidateConsumption = (ledger) => {
        Object.keys(ledger).forEach(n => {
            if(!consumptionTotals[n]) consumptionTotals[n] = {qty: 0, cost: 0};
            consumptionTotals[n].qty += ledger[n].qty;
            consumptionTotals[n].cost += ledger[n].cost;
        });
    };
    consolidateConsumption(salesUsage);
    consolidateConsumption(wasteUsage);

    // 4. ุจูุงุก ุฌุฏูู ุงูุฑุตูุฏ ุงูุญุงูู
    const currentInvTbl = document.getElementById('currentInvTbl');
    let header = '<tr><th>ุงููุงุฏุฉ</th><th>ุงููุญุฏุฉ ุงูุฃุณุงุณูุฉ</th><th>BB ุงููููุฉ</th><th>ูุดุชุฑูุงุช ุงููููุฉ</th><th>ุงุณุชููุงู (ูุจูุนุงุช + ูุฏุฑ)</th><th>ุงูุฑุตูุฏ ุงูุญุงูู (ุงููุชููุฑ ูุธุฑูุงู)</th></tr>';
    let rowsHtml = '';
    const allMaterials = new Set([...ing.map(i=>i.n)]);

    allMaterials.forEach(name => {
        const material = ing.find(i => i.n === name);
        if (!material) return;
        
        const bb = bbData.find(i => i.name === name) || {qty: 0};
        const purchase = purchaseTotals[name] || {qty: 0};
        const consumption = consumptionTotals[name] || {qty: 0};

        const currentBalance = bb.qty + purchase.qty - consumption.qty;
        const unitLabel = material.baseUnit === 'g' ? 'ุฌุฑุงู' : (material.baseUnit === 'ml' ? 'ูู' : 'ุญุจุฉ');

        rowsHtml += `
            <tr>
                <td>${name}</td>
                <td>${unitLabel}</td>
                <td>${bb.qty.toFixed(2)}</td>
                <td>${purchase.qty.toFixed(2)}</td>
                <td>${consumption.qty.toFixed(2)}</td>
                <td style="font-weight: bold; color: ${currentBalance < 0 ? '#fca5a5' : '#a7f3d0'};">${currentBalance.toFixed(2)}</td>
            </tr>
        `;
    });
    currentInvTbl.innerHTML = header + rowsHtml;
}


/************ ุฏูุงู ุตูุญุฉ ุงูุฌุฑุฏ ูุงูููุงุฑูุฉ (Variance) ************/
function addEBRow(ebDataRow){
    const tbl = document.getElementById('ebTbl');
    if(!tbl) return;
    const tr = document.createElement('tr');
    const nameVal = ebDataRow ? ebDataRow.name : '';
    const qtyVal = ebDataRow ? ebDataRow.qty : '';
    const priceVal = ebDataRow ? ebDataRow.cost : '';

    tr.innerHTML = `
        <td>
            <input class="eb-name-input" placeholder="ุงูุชุจ ุงุณู ุงููุงุฏุฉ ูุงุฎุชุฑูุง" list="ebIngList" value="${nameVal || ''}" oninput="/* ูุง ุดูุก */">
        </td>
        <td>
            <input type="number" class="eb-qty-input" value="${qtyVal || ''}" oninput="/* ูุง ุดูุก */">
        </td>
        <td>
            <input type="number" class="eb-price-input" value="${priceVal || ''}" oninput="/* ูุง ุดูุก */">
        </td>
        <td><button class="secondary" onclick="deleteEBRow(this)">ุญุฐู</button></td>
    `;
    tbl.appendChild(tr);
}
function deleteEBRow(btn){
    const tr = btn.closest('tr');
    tr.parentNode.removeChild(tr);
}

function calculateVariance(){
    // ูุฌุจ ุชุดุบูู ุฌููุน ุงูุฏูุงู ุงูุญุณุงุจูุฉ ุฃููุงู
    recalcPurchases();
    calcWaste();
    calcSales();
    calculateInventoryLevels();

    // 1. ุชุฌููุน ุฑุตูุฏ ุขุฎุฑ ุงููุฏุฉ (EB)
    ebData = [];
    document.querySelectorAll('#ebTbl tr').forEach((tr, idx) => {
        if(idx === 0) return;
        const name = (tr.querySelector('.eb-name-input').value || '').trim();
        const qty = parseFloat(tr.querySelector('.eb-qty-input').value) || 0;
        const cost = parseFloat(tr.querySelector('.eb-price-input').value) || 0;

        const material = ing.find(i => i.n === name);
        if(material && qty > 0 && cost >= 0){
            const {qty: baseQty} = convertToBaseUnit(qty, material.baseUnit); 
            ebData.push({name, qty: baseQty, cost});
        }
    });

    const varianceTbl = document.getElementById('varianceTbl');
    if(!varianceTbl) return;

    let header = '<tr><th>ุงููุงุฏุฉ</th><th>ุงูุงุณุชุฎุฏุงู ุงููุธุฑู</th><th>ุงูุงุณุชุฎุฏุงู ุงููุนูู</th><th>ุงููุฏุฑ ุบูุฑ ุงููุณุฌู (ุงููููุฉ)</th><th>ุชูููุฉ ุงููุฏุฑ ุบูุฑ ุงููุณุฌู (ุฑูุงู)</th></tr>';
    let rowsHtml = '';
    const allMaterials = new Set([...ing.map(i=>i.n)]);

    // ุชุฌููุน ุฅุฌูุงูู ุงููุดุชุฑูุงุช
    const purchaseTotals = {};
    purchases.forEach(p => p.items.forEach(item => {
        const {qty: baseQty} = convertToBaseUnit(item.qty, item.unit);
        if(!purchaseTotals[item.name]) purchaseTotals[item.name] = {qty: 0, cost: 0};
        purchaseTotals[item.name].qty += baseQty;
        purchaseTotals[item.name].cost += item.price;
    }));

    allMaterials.forEach(name => {
        const material = ing.find(i => i.n === name);
        if (!material) return;

        // ุงูุงุณุชุฎุฏุงู ุงููุธุฑู = ุงููุจูุนุงุช + ุงููุฏุฑ ุงููุณุฌู
        const theoreticalUsageQty = (salesUsage[name]?.qty || 0) + (wasteUsage[name]?.qty || 0);

        // ุงูุงุณุชุฎุฏุงู ุงููุนูู = (BB + ูุดุชุฑูุงุช) - EB
        const bbQty = bbData.find(i => i.name === name)?.qty || 0;
        const purchaseQty = purchaseTotals[name]?.qty || 0;
        const ebQty = ebData.find(i => i.n === name)?.qty || 0;
        const actualUsageQty = bbQty + purchaseQty - ebQty;

        // ุงููุฏุฑ ุบูุฑ ุงููุณุฌู = ุงูุงุณุชุฎุฏุงู ุงููุนูู - ุงูุงุณุชุฎุฏุงู ุงููุธุฑู
        const unaccountedVarianceQty = actualUsageQty - theoreticalUsageQty;

        // ูููุฉ ุงููุฏุฑ ุบูุฑ ุงููุณุฌู
        const basePrice = material.basePrice;
        const unaccountedVarianceCost = unaccountedVarianceQty * basePrice;
        
        const className = unaccountedVarianceQty > 0 ? 'variance-td-over' : (unaccountedVarianceQty < 0 ? 'variance-td-short' : '');
        const unitLabel = material.baseUnit === 'g' ? 'ุฌุฑุงู' : (material.baseUnit === 'ml' ? 'ูู' : 'ุญุจุฉ');

        rowsHtml += `
            <tr>
                <td>${name}</td>
                <td>${theoreticalUsageQty.toFixed(2)} ${unitLabel}</td>
                <td>${actualUsageQty.toFixed(2)} ${unitLabel}</td>
                <td class="${className}">${unaccountedVarianceQty.toFixed(2)} ${unitLabel}</td>
                <td class="${className}">${unaccountedVarianceCost.toFixed(2)} ุฑูุงู</td>
            </tr>
        `;
    });

    varianceTbl.innerHTML = header + rowsHtml;
}


/************ ุชุตุฏูุฑ / ุงุณุชูุฑุงุฏ ุงูุจูุงูุงุช ************/
function exportData(){
    // ... (ููุทู ุชุฌููุน ุงูููุชุฌุงุช recipes ู mixRecipes)
    // ...

    const data = {
        ingredients: ing,
        mixes: mixes, 
        mixRecipes: mixRecipes,
        recipes: recipes,
        purchases: purchasesData,
        bbData: bbData, // ุชู ุชุบููุฑ ุงุณู ุงููุชุบูุฑ
        ebData: ebData, // ุชู ุชุบููุฑ ุงุณู ุงููุชุบูุฑ
        wasteData: wasteData // ุงูุฌุฏูุฏ
    };
    
    // ... (ููุทู ุงูุชุตุฏูุฑ)
}

document.getElementById('fileInput').addEventListener('change', function(e){
    // ... (ููุทู ุงุณุชูุฑุงุฏ ุงูุจูุงูุงุช)

    // ุงุณุชูุฑุงุฏ ุชุนุฑูู ุงูููุงุฏ
    if(Array.isArray(data.ingredients)){
        ing = data.ingredients;
        renderDefTbl();
    }

    // ... (ุงุณุชูุฑุงุฏ ุงูุฎูุทุงุช ูุงูููุชุฌุงุช)

    // ุงุณุชูุฑุงุฏ ุงููุดุชุฑูุงุช
    const purchaseContainer = document.getElementById('purchasesContainer');
    purchaseContainer.innerHTML = '';
    if(Array.isArray(data.purchases)){
        data.purchases.forEach(p => addPurchaseBlock(p));
    }

    // ุงุณุชูุฑุงุฏ ุฑุตูุฏ ุฃูู ุงููุฏุฉ (BB)
    if(Array.isArray(data.bbData)){
        bbData = data.bbData;
        const bbTbl = document.getElementById('bbTbl');
        bbTbl.innerHTML = '<tr><th>ุงุณู ุงููุงุฏุฉ (ุจุญุซ)</th><th>BB ุงููููุฉ (ูุญุฏุฉ ุงูุดุฑุงุก)</th><th>BB ุงูุณุนุฑ ุงูุฅุฌูุงูู</th><th>ุญุฐู</th></tr>';
        bbData.forEach(d => {
            const material = ing.find(i => i.n === d.name);
            if(material){
                // ูุญูู ุงููููุฉ ูู ูุญุฏุฉ ุฃุณุงุณูุฉ ุฅูู ูุญุฏุฉ ุชุนุฑูู ุงููุงุฏุฉ ููุนุฑุถ ูู ุงูุญูู
                let qtyForInput = d.qty;
                if(material.baseUnit === 'g') qtyForInput /= 1000;
                if(material.baseUnit === 'ml') qtyForInput /= 1000;
                addBBRow({name: d.name, qty: qtyForInput, cost: d.cost});
            }
        });
    }

    // ุงุณุชูุฑุงุฏ ุงููุฏุฑ (Waste)
    if(Array.isArray(data.wasteData)){
        wasteData = data.wasteData;
        const wasteTbl = document.getElementById('wasteTbl');
        wasteTbl.innerHTML = '<tr><th>ุงูููุน</th><th>ุงูุงุณู (ูุงุฏุฉ ุฃู ููุชุฌ)</th><th>ุงููููุฉ</th><th>ุงูุชูููุฉ ุงูุชูุฑูุจูุฉ</th><th>ุญุฐู</th></tr>';
        wasteData.forEach(d => addWasteRow(d));
    }

    // ุงุณุชูุฑุงุฏ ุฑุตูุฏ ุขุฎุฑ ุงููุฏุฉ (EB)
    if(Array.isArray(data.ebData)){
        ebData = data.ebData;
        const ebTbl = document.getElementById('ebTbl');
        ebTbl.innerHTML = '<tr><th>ุงุณู ุงููุงุฏุฉ (ุจุญุซ)</th><th>EB ุงููููุฉ (ูุญุฏุฉ ุงูุดุฑุงุก)</th><th>EB ุงูุณุนุฑ ุงูุฅุฌูุงูู</th><th>ุญุฐู</th></tr>';
        ebData.forEach(d => {
            const material = ing.find(i => i.n === d.name);
            if(material){
                // ูุญูู ุงููููุฉ ูู ูุญุฏุฉ ุฃุณุงุณูุฉ ุฅูู ูุญุฏุฉ ุชุนุฑูู ุงููุงุฏุฉ ููุนุฑุถ ูู ุงูุญูู
                let qtyForInput = d.qty;
                if(material.baseUnit === 'g') qtyForInput /= 1000;
                if(material.baseUnit === 'ml') qtyForInput /= 1000;
                addEBRow({name: d.name, qty: qtyForInput, cost: d.cost});
            }
        });
    }

    // ุฅุนุงุฏุฉ ุงูุญุณุงุจ ุงูุดุงูู
    updateAllLookupsAndUnits();
    recalcPurchases(); 
    recalcMixes(); 
    calcProducts(); 
    calcWaste(); 
    calcSales();
    calculateInventoryLevels();
});

// ุชููุฆุฉ ุฃูููุฉ
document.addEventListener('DOMContentLoaded', () => {
    // ... (ุฅุถุงูุฉ ุจููู ุฎูุทุฉ ูููุชุฌ ููุดุชุฑูุงุช ู BB ู Waste)
});
</script>
</body>
</html>
