<!DOCTYPE html>

<html dir="rtl" lang="ar">
<head>
<meta charset="utf-8"/>
<title>Ù†Ø¸Ø§Ù… Ø­Ø³Ø§Ø¨ ØªÙƒÙ„ÙØ© Ø§Ù„ÙˆØµÙØ§Øª Ù„Ù„Ù…Ø·Ø§Ø¹Ù… ÙˆØ§Ù„ÙƒØ§ÙÙŠÙ‡Ø§Øª</title>
<style>
body{
  font-family:Arial,Helvetica,sans-serif;
  margin:0;
  direction:rtl;
  background:#020617;
  color:#e5e7eb;
}
.navbar{
  background:#020617;
  color:#f9fafb;
  padding:10px 16px;
  display:flex;
  justify-content:space-between;
  align-items:center;
  border-bottom:1px solid #1f2937;
  position:sticky;
  top:0;
  z-index:10;
}
.nav-title{
  font-size:16px;
  font-weight:bold;
}
.nav-buttons button{
  margin-inline:4px;
  padding:6px 12px;
  border-radius:999px;
  border:none;
  cursor:pointer;
  font-size:13px;
  transition:background .15s,transform .1s;
}
.nav-buttons button.active{
  background:#f97316;
  color:#111827;
}
.nav-buttons button.inactive{
  background:#111827;
  color:#e5e7eb;
}
.nav-buttons button:hover{
  transform:translateY(-1px);
}
.page{
  max-width:1100px;
  margin:16px auto 24px;
  background:#020617;
  padding:20px;
  border-radius:16px;
  box-shadow:0 18px 45px rgba(0,0,0,.45);
  border:1px solid #1e293b;
  display:none;
}
.page.active{
  display:block;
}
h2{
  margin-top:0;
  font-size:18px;
  color:#f9fafb;
}
table{
  width:100%;
  border-collapse:collapse;
  margin-top:10px;
  font-size:13px;
}
td,th{
  border:1px solid #1f2937;
  padding:6px;
  text-align:center;
}
th{
  background:#020617;
  color:#f97316;
  font-weight:600;
}
input,select,button.action{
  padding:6px 8px;
  border-radius:8px;
  border:1px solid #374151;
  font-size:13px;
  box-sizing:border-box;
  background:#020617;
  color:#e5e7eb;
}
input::placeholder{
  color:#6b7280;
}
input,select{
  width:100%;
}
button.action{
  cursor:pointer;
  background:#f97316;
  color:#111827;
  border:none;
  font-weight:600;
}
button.action:hover{
  background:#ea580c;
}
button.secondary{
  background:#111827;
  color:#e5e7eb;
  border:1px solid #374151;
  cursor:pointer;
}
button.secondary:hover{
  background:#1f2937;
}
.small{
  font-size:11px;
  color:#9ca3af;
}
.unit-label{
  font-size:11px;
  color:#9ca3af;
  margin-right:4px;
}
.btn-row{
  margin-top:10px;
  display:flex;
  gap:8px;
  flex-wrap:wrap;
}
.summary-table{
  margin-top:10px;
}
/* ØªÙ†Ø³ÙŠÙ‚ Ø§Ù„Ø£Ø®Ø·Ø§Ø¡ */
.bad{
  background:#450a0a !important;
  color:#fecaca;
  border-color:#fca5a5 !important;
}
.bad .prod-total-line, .bad .mix-total-line{
    color: #fca5a5;
}
.error-text{
  font-size:11px;
  color:#fecaca;
  text-align:right;
}
.product-block, .mix-block{
  border:1px solid #1f2937;
  border-radius:14px;
  padding:10px 10px 12px;
  margin-top:12px;
  background:#020617;
  transition:border-color 0.3s;
}
.prod-header, .mix-header{
  display:flex;
  flex-wrap:wrap;
  gap:8px;
  align-items:center;
  justify-content:space-between;
  margin-bottom:6px;
}
.prod-header-left, .mix-header-left{
  flex:1 1 auto;
  display:flex;
  gap:6px;
  align-items:center;
}
.prod-header-left input, .mix-header-left input{
  flex:1 1 auto;
}
.prod-total-line, .mix-total-line{
  margin-top:6px;
  font-size:12px;
  font-weight:bold;
  text-align:left;
  color:#f97316;
}
hr.divider{
  border:none;
  border-top:1px dashed #334155;
  margin:8px 0 12px;
}
.bad input,
.bad select{
  border-color:#fca5a5;
}
</style>
</head>
<body>
<div class="navbar">
<div class="nav-title">Ù†Ø¸Ø§Ù… Ø­Ø³Ø§Ø¨ ØªÙƒÙ„ÙØ© Ø§Ù„ÙˆØµÙØ§Øª</div>
<div class="nav-buttons">
<button class="active" id="btnInv" onclick="showPage('inv')">ğŸ“¦ Ù…ÙˆØ§Ø¯ Ø§Ù„Ù…Ø®Ø²ÙˆÙ†</button>
<button class="inactive" id="btnMix" onclick="showPage('mix')">ğŸ§ª Ø§Ù„Ø®Ù„Ø·Ø§Øª</button>
<button class="inactive" id="btnProd" onclick="showPage('prod')">â˜• Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª / Ø§Ù„ÙˆØµÙØ§Øª</button>
<button class="inactive" id="btnSales" onclick="showPage('sales')">ğŸ“Š Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª</button></div>
</div>
<div class="page active" id="pageInv">
<h2>ğŸ“¦ ØµÙØ­Ø© Ù…ÙˆØ§Ø¯ Ø§Ù„Ù…Ø®Ø²ÙˆÙ†</h2>
<p class="small">
    Ø£Ø¯Ø®Ù„ Ø§Ø³Ù… Ø§Ù„Ù…Ø§Ø¯Ø©ØŒ ÙˆØ­Ø¯Ø© Ø§Ù„Ø´Ø±Ø§Ø¡ (ÙƒÙŠÙ„Ùˆ / Ù„ØªØ± / Ø¬Ø±Ø§Ù… / Ù…Ù„ / Ø­Ø¨Ø©)ØŒ Ø§Ù„ÙƒÙ…ÙŠØ© Ø§Ù„Ù…Ø´ØªØ±Ø§Ø© (Ù…Ø«Ø§Ù„: 10 ÙƒÙŠÙ„Ùˆ)ØŒ ÙˆØ³Ø¹Ø± Ø§Ù„ÙØ§ØªÙˆØ±Ø© Ø§Ù„ÙƒÙ„ÙŠ.
    <br/>ğŸš« Ù„Ø§ ÙŠØ³Ù…Ø­ Ø¨ØªÙƒØ±Ø§Ø± Ù†ÙØ³ Ø§Ø³Ù… Ø§Ù„Ù…Ø§Ø¯Ø© Ù…Ø±ØªÙŠÙ†.
  </p>
<input id="name" placeholder="Ø§Ø³Ù… Ø§Ù„Ù…Ø§Ø¯Ø© (Ù…Ø«Ø§Ù„: Ø­Ù„ÙŠØ¨ ÙƒØ§Ù…Ù„ Ø§Ù„Ø¯Ø³Ù…)"/><br/><br/>
<select id="unit">
<option value="kg">ÙƒÙŠÙ„Ùˆ (Kg)</option>
<option value="g">Ø¬Ø±Ø§Ù… (g)</option>
<option value="l">Ù„ØªØ± (L)</option>
<option>Ù…Ù„ (ml)</option>
<option value="pc">Ø­Ø¨Ø© (Pc)</option>
</select><br/><br/>
<input id="qty" placeholder="Ø§Ù„ÙƒÙ…ÙŠØ© Ø§Ù„Ù…Ø´ØªØ±Ø§Ø© (Ù…Ø«Ø§Ù„: 10)" type="number"/><br/><br/>
<input id="price" placeholder="Ø§Ù„Ø³Ø¹Ø± Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ (Ù…Ø«Ø§Ù„: 850)" type="number"/><br/><br/>
<button class="action" onclick="addIng()">Ø¥Ø¶Ø§ÙØ© Ù„Ù„Ù…Ø®Ø²ÙˆÙ†</button>
<table id="ingTbl">
<tr><th>Ø§Ù„Ù…Ø§Ø¯Ø©</th><th>Ø§Ù„ÙˆØ­Ø¯Ø© Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ©</th><th>Ø³Ø¹Ø± Ø§Ù„ÙˆØ­Ø¯Ø© Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ©</th><th>Ø­Ø°Ù</th></tr>
</table>
<p class="small">
    **Ù…Ù„Ø§Ø­Ø¸Ø© Ù‡Ø§Ù…Ø©:** ÙˆØ­Ø¯Ø© Ø§Ù„Ø­Ø³Ø§Ø¨ Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ© ÙÙŠ Ø§Ù„Ù†Ø¸Ø§Ù… Ù‡ÙŠ **Ø§Ù„Ø¬Ø±Ø§Ù… (g)** Ùˆ**Ø§Ù„Ù…Ù„ÙŠÙ„ØªØ± (ml)** Ùˆ**Ø§Ù„Ø­Ø¨Ø© (pc)**.
  </p>
</div>
<div class="page" id="pageMix">
<h2>ğŸ§ª ØµÙØ­Ø© Ø§Ù„Ø®Ù„Ø·Ø§Øª</h2>
<p class="small">
    Ø§Ù„Ø®Ù„Ø·Ø© Ù‡ÙŠ Ù…Ø¬Ù…ÙˆØ¹Ø© Ù…ÙˆØ§Ø¯ Ù…Ù† Ø§Ù„Ù…Ø®Ø²ÙˆÙ† ØªÙØ³ØªØ®Ø¯Ù… Ù„Ø§Ø­Ù‚Ø§Ù‹ ÙÙŠ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠØ© Ø¨ÙƒÙ…ÙŠØ§Øª Ø¬Ø²Ø¦ÙŠØ©.<br/>
    âœ… **Ù„Ø§ ØªØ­ØªØ§Ø¬ Ù„ØªÙƒØ±Ø§Ø± Ø§Ø³Ù… Ø§Ù„Ø®Ù„Ø·Ø© ÙÙŠ ÙƒÙ„ Ø³Ø·Ø±.** Ø§Ø¶ØºØ· Ø¹Ù„Ù‰ Ø²Ø± "Ø¥Ø¶Ø§ÙØ© Ø®Ù„Ø·Ø© Ø¬Ø¯ÙŠØ¯Ø©" Ù„Ù„Ø¨Ø¯Ø¡.
    <br/>ğŸ” Ø®Ø§Ù†Ø© Ø§Ù„Ù…Ø§Ø¯Ø© Ù‡Ù†Ø§ ÙÙŠÙ‡Ø§ Ø¨Ø­Ø«: Ø§ÙƒØªØ¨ Ø§Ø³Ù… Ø§Ù„Ù…Ø§Ø¯Ø© ÙˆØ§Ø®ØªØ±Ù‡Ø§ Ù…Ù† Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©.
  </p>

<div class="btn-row">
<button class="secondary" onclick="addMixBlock()">+ Ø¥Ø¶Ø§ÙØ© Ø®Ù„Ø·Ø© Ø¬Ø¯ÙŠØ¯Ø©</button>
</div>

<div id="mixesContainer"></div>

<h3 style="margin-top:18px;font-size:15px;">âš–ï¸ ØªØ¹Ø±ÙŠÙ ÙˆØ²Ù† ÙƒÙ„ Ø®Ù„Ø·Ø©</h3>
<table class="summary-table" id="mixSummary">
<tr>
<th>Ø§Ø³Ù… Ø§Ù„Ø®Ù„Ø·Ø©</th>
<th>Ø¥Ø¬Ù…Ø§Ù„ÙŠ ØªÙƒÙ„ÙØ© Ø§Ù„Ø®Ù„Ø·Ø© (Ø±ÙŠØ§Ù„)</th>
<th>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„ÙˆØ²Ù†</th>
<th>Ø§Ù„ÙˆØ­Ø¯Ø©</th>
<th>ØªÙƒÙ„ÙØ© Ø§Ù„ÙˆØ­Ø¯Ø© (Ø±ÙŠØ§Ù„ / Ù…Ù„ Ø£Ùˆ Ø¬Ø±Ø§Ù…)</th>
</tr>
</table>
<p class="small">
    Ø£Ø¯Ø®Ù„ Ø¥Ø¬Ù…Ø§Ù„ÙŠ ÙˆØ²Ù† Ø§Ù„Ø®Ù„Ø·Ø© (Ù…Ø«Ù„Ø§Ù‹ 700 Ù…Ù„)ØŒ ÙˆØ³ÙŠØªÙ… Ø­Ø³Ø§Ø¨ ØªÙƒÙ„ÙØ© ÙƒÙ„ 1 Ù…Ù„ Ø£Ùˆ 1 Ø¬Ø±Ø§Ù… Ø¨Ø´ÙƒÙ„ ØªÙ„Ù‚Ø§Ø¦ÙŠ Ù„Ø§Ø³ØªØ®Ø¯Ø§Ù…Ù‡ Ø¯Ø§Ø®Ù„ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª.
  </p>
</div>
<div class="page" id="pageProd">
<h2>â˜• ØµÙØ­Ø© Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª / Ø§Ù„ÙˆØµÙØ§Øª</h2>
<p class="small">
    âœ… ÙƒÙ„ Ù…Ù†ØªØ¬ Ù…Ø³ØªÙ‚Ù„ØŒ ÙˆØªØ­ØªÙ‡ Ø£Ø³Ø·Ø± Ø§Ù„Ù…ÙˆØ§Ø¯/Ø§Ù„Ø®Ù„Ø·Ø§Øª Ø§Ù„Ø®Ø§ØµØ© Ø¨Ù‡.<br/>
    - Ø²Ø± <b>+ Ø¥Ø¶Ø§ÙØ© Ù…Ù†ØªØ¬ Ø¬Ø¯ÙŠØ¯</b> ÙŠØ¶ÙŠÙ Ø¨Ù„ÙˆÙƒ Ø®Ø§Øµ Ø¨Ø§Ø³Ù… Ø§Ù„Ù…Ù†ØªØ¬.<br/>
    - Ø¯Ø§Ø®Ù„ ÙƒÙ„ Ù…Ù†ØªØ¬ Ø²Ø± <b>+ Ø¥Ø¶Ø§ÙØ© Ù…Ø§Ø¯Ø© / Ø®Ù„Ø·Ø©</b> Ù„Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…ÙƒÙˆÙ†Ø§Øª Ù„Ù‡Ø°Ø§ Ø§Ù„Ù…Ù†ØªØ¬ ÙÙ‚Ø·.<br/>
    <br/>
    **ØªÙ†Ø¨ÙŠÙ‡ Ù‡Ù€Ù€Ù€Ù€Ø§Ù…:** Ø¥Ø°Ø§ ÙƒØ§Ù†Øª Ø£ÙŠ Ø®Ø§Ù†Ø© Ù…ÙƒÙˆÙ†Ø§Øª (Ù…Ø§Ø¯Ø© Ø£Ùˆ Ø®Ù„Ø·Ø©) ØºÙŠØ± ØµØ­ÙŠØ­Ø© Ø£Ùˆ ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯Ø©ØŒ Ø³ÙŠØªÙ… ØªØµÙÙŠØ± **Ø¥Ø¬Ù…Ø§Ù„ÙŠ ØªÙƒÙ„ÙØ© Ø§Ù„Ù…Ù†ØªØ¬ Ø¨Ø§Ù„ÙƒØ§Ù…Ù„** ÙˆÙ„Ù† ÙŠØ¸Ù‡Ø± ÙÙŠ Ø§Ù„Ù…Ù„Ø®ØµØŒ ÙˆØ³ØªØ¸Ù‡Ø± Ø®Ù„ÙÙŠØ© Ø­Ù…Ø±Ø§Ø¡ Ù„ØªÙ†Ø¨ÙŠÙ‡Ùƒ.
  </p>
<div class="btn-row">
<button class="secondary" onclick="addProductBlock()">+ Ø¥Ø¶Ø§ÙØ© Ù…Ù†ØªØ¬ Ø¬Ø¯ÙŠØ¯</button>
<button class="secondary" onclick="exportData()">ğŸ’¾ Ø­ÙØ¸ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ÙƒÙ…Ù„Ù</button>
<button class="secondary" onclick="document.getElementById('fileInput').click()">ğŸ“‚ Ø§Ø³ØªØ¹Ø§Ø¯Ø© Ù…Ù† Ù…Ù„Ù</button>
<button class="secondary" onclick="exportPDF()">ğŸ–¨ï¸ ØªØµØ¯ÙŠØ± ØªÙ‚Ø±ÙŠØ± PDF</button>
</div>
<div id="productsContainer"></div>
<h3 style="margin-top:18px;">Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ù„ÙƒÙ„ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª Ø§Ù„ØµØ§Ù„Ø­Ø©: <span id="total">0.00</span> Ø±ÙŠØ§Ù„</h3>
<h3>ğŸ“Š Ù…Ù„Ø®Øµ ØªÙƒÙ„ÙØ© ÙƒÙ„ Ù…Ù†ØªØ¬</h3>
<table class="summary-table" id="productSummary">
<tr><th>Ø§Ø³Ù… Ø§Ù„Ù…Ù†ØªØ¬</th><th>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„ØªÙƒÙ„ÙØ© (Ø±ÙŠØ§Ù„)</th></tr>
</table>
<p class="small">ÙŠØªÙ… Ø­ÙØ¸ Ù…ÙˆØ§Ø¯ Ø§Ù„Ù…Ø®Ø²ÙˆÙ† ÙˆØ§Ù„Ø®Ù„Ø·Ø§Øª ÙˆÙƒÙ„ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª Ø¯Ø§Ø®Ù„ Ù…Ù„Ù ÙˆØ§Ø­Ø¯ Ø¹Ù†Ø¯ Ø§Ù„ØªØµØ¯ÙŠØ± (cost_data.json).</p>
<input accept=".json" id="fileInput" style="display:none" type="file">
</input></div>
<div class="page" id="pageSales">
<h2>ğŸ“Š ØµÙØ­Ø© Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª ÙˆØ§Ø³ØªÙ‡Ù„Ø§Ùƒ Ø§Ù„Ù…ÙˆØ§Ø¯</h2>
<p class="small">
    âœ… Ø§ÙƒØªØ¨ Ø§Ø³Ù… Ø§Ù„Ù…Ù†ØªØ¬ ÙƒÙ…Ø§ Ù‡Ùˆ ÙÙŠ ØµÙØ­Ø© Ø§Ù„Ù…Ù†ØªØ¬Ø§ØªØŒ ÙˆØ¹Ø¯Ø¯ Ø§Ù„Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ù…Ø¨ÙŠØ¹Ø© Ù„ÙƒÙ„ Ù…Ù†ØªØ¬ØŒ Ø«Ù… Ø§Ø¶ØºØ· Ø¹Ù„Ù‰ Ø²Ø± <b>Ø­Ø³Ø§Ø¨ Ø§Ù„Ø§Ø³ØªÙ‡Ù„Ø§Ùƒ</b>.
    <br/>ğŸ” Ø§Ø³ØªØ®Ø¯Ù… Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø¨Ø­Ø« Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠ Ù„Ø§Ø®ØªÙŠØ§Ø± Ø§Ø³Ù… Ø§Ù„Ù…Ù†ØªØ¬ Ù„ØªÙØ§Ø¯ÙŠ Ø§Ù„Ø£Ø®Ø·Ø§Ø¡.
  </p>
<div class="card">
<div class="btn-row">
<button class="secondary" onclick="addSalesRow()">+ Ø¥Ø¶Ø§ÙØ© Ø³Ø·Ø± Ù…Ø¨ÙŠØ¹Ø§Øª</button>
<button class="secondary" onclick="clearSalesRows()">Ù…Ø³Ø­ ÙƒÙ„ Ø§Ù„Ø³Ø·ÙˆØ±</button>
<button class="action" onclick="calcSales()">Ø­Ø³Ø§Ø¨ Ø§Ù„Ø§Ø³ØªÙ‡Ù„Ø§Ùƒ</button>
</div>
<table id="salesTbl">
<tr>
<th>Ø§Ø³Ù… Ø§Ù„Ù…Ù†ØªØ¬</th>
<th>Ø¹Ø¯Ø¯ Ø§Ù„Ø·Ù„Ø¨Ø§Øª / Ø§Ù„Ø£ÙƒÙˆØ§Ø¨</th>
<th>Ù…Ù„Ø§Ø­Ø¸Ø©</th>
<th>Ø­Ø°Ù</th>
</tr>
</table>
</div>
<div class="card">
<h3>Ù…Ù„Ø®Øµ Ø§Ø³ØªÙ‡Ù„Ø§Ùƒ Ø§Ù„Ù…ÙˆØ§Ø¯ Ù…Ù† Ø§Ù„Ù…Ø®Ø²ÙˆÙ†</h3>
<table id="salesSummary">
<tr>
<th>Ø§Ø³Ù… Ø§Ù„Ù…Ø§Ø¯Ø©</th>
<th>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„ÙƒÙ…ÙŠØ© Ø§Ù„Ù…Ø³ØªÙ‡Ù„ÙƒØ©</th>
<th>Ø§Ù„ÙˆØ­Ø¯Ø©</th>
<th>Ø§Ù„ØªÙƒÙ„ÙØ© Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠØ© (Ø±ÙŠØ§Ù„)</th>
</tr>
</table>
</div>
</div>

<datalist id="ingList"></datalist>
<datalist id="mixList"></datalist><datalist id="salesProdList"></datalist>
<script>
let ing = [];   // Ø§Ù„Ù…ÙˆØ§Ø¯ Ø§Ù„Ø®Ø§Ù…: {n, basePrice, baseUnit}
let mixes = []; // Ø§Ù„Ø®Ù„Ø·Ø§Øª Ø§Ù„Ù…Ø¹ØªÙ…Ø¯Ø© (Ù„Ø­Ø³Ø§Ø¨ Ø§Ù„ØªÙƒÙ„ÙØ©): {name, totalCost, items:[{material, qty}], totalWeight, unit}

/************ Ø§Ù„ØªÙ†Ù‚Ù„ Ø¨ÙŠÙ† Ø§Ù„ØµÙØ­Ø§Øª ************/
function showPage(which){
  const inv = document.getElementById('pageInv');
  const mix = document.getElementById('pageMix');
  const prod = document.getElementById('pageProd');
  const sales = document.getElementById('pageSales');
  const btnInv = document.getElementById('btnInv');
  const btnMix = document.getElementById('btnMix');
  const btnProd = document.getElementById('btnProd');
  const btnSales = document.getElementById('btnSales');

  inv.classList.remove('active');
  mix.classList.remove('active');
  prod.classList.remove('active');
  if(sales){ sales.classList.remove('active'); }

  btnInv.classList.add('inactive'); btnInv.classList.remove('active');
  btnMix.classList.add('inactive'); btnMix.classList.remove('active');
  btnProd.classList.add('inactive'); btnProd.classList.remove('active');
  if(btnSales){ btnSales.classList.add('inactive'); btnSales.classList.remove('active'); }

  if(which === 'inv'){
    inv.classList.add('active');
    btnInv.classList.add('active'); btnInv.classList.remove('inactive');
  }else if(which === 'mix'){
    mix.classList.add('active');
    btnMix.classList.add('active'); btnMix.classList.remove('inactive');
    recalcMixes(); // ØªØ£ÙƒØ¯ Ù…Ù† ØªØ­Ø¯ÙŠØ« Ù…Ù„Ø®Øµ Ø§Ù„Ø®Ù„Ø·Ø§Øª Ø¹Ù†Ø¯ Ø§Ù„Ø§Ù†ØªÙ‚Ø§Ù„
  }else if(which === 'prod'){
    prod.classList.add('active');
    btnProd.classList.add('active'); btnProd.classList.remove('inactive');
    calcProducts(); // ØªØ£ÙƒØ¯ Ù…Ù† ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª Ø¹Ù†Ø¯ Ø§Ù„Ø§Ù†ØªÙ‚Ø§Ù„
  }else if(which === 'sales' && sales && btnSales){
    sales.classList.add('active');
    btnSales.classList.add('active'); btnSales.classList.remove('inactive');
    refreshSalesProductList(); // ØªØ­Ø¯ÙŠØ« Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª Ù„Ù„Ù…Ø¨ÙŠØ¹Ø§Øª Ø¹Ù†Ø¯ Ø§Ù„Ø§Ù†ØªÙ‚Ø§Ù„ Ù„Ù„ØµÙØ­Ø©
  }
}

/************ ØµÙØ­Ø© Ø§Ù„Ù…Ø®Ø²ÙˆÙ† ************/
function addIng(){
  const n = document.getElementById('name').value.trim();
  const u = document.getElementById('unit').value;
  const q = parseFloat(document.getElementById('qty').value);
  const p = parseFloat(document.getElementById('price').value);
  if(!n || !q || !p || q<=0 || p<=0){
    alert('Ø£Ø¯Ø®Ù„ Ø§Ù„Ø§Ø³Ù… ÙˆØ§Ù„ÙƒÙ…ÙŠØ© ÙˆØ§Ù„Ø³Ø¹Ø± Ø¨Ø´ÙƒÙ„ ØµØ­ÙŠØ­ (ÙŠØ¬Ø¨ Ø£Ù† ØªÙƒÙˆÙ† Ø§Ù„ÙƒÙ…ÙŠØ© ÙˆØ§Ù„Ø³Ø¹Ø± Ø£ÙƒØ¨Ø± Ù…Ù† ØµÙØ±).');
    return;
  }

  // Ù…Ù†Ø¹ ØªÙƒØ±Ø§Ø± Ù†ÙØ³ Ø§Ù„Ø§Ø³Ù…
  const exists = ing.some(i=>i.n === n);
  if(exists){
    alert('Ù‡Ø°Ù‡ Ø§Ù„Ù…Ø§Ø¯Ø© Ù…ÙˆØ¬ÙˆØ¯Ø© Ø¨Ø§Ù„ÙØ¹Ù„ ÙÙŠ Ø§Ù„Ù…Ø®Ø²ÙˆÙ† Ø¨Ù†ÙØ³ Ø§Ù„Ø§Ø³Ù….');
    return;
  }

  let baseQty = 1;
  let baseUnit = 'g';
  if(u==='kg'){ baseQty = q*1000; baseUnit='g'; }
  else if(u==='g'){ baseQty = q; baseUnit='g'; }
  else if(u==='l'){ baseQty = q*1000; baseUnit='ml'; }
  else if(u==='ml'){ baseQty = q; baseUnit='ml'; }
  else { baseQty = q; baseUnit='pc'; } // Ø­Ø¨Ø©

  const basePrice = p / baseQty; // Ø³Ø¹Ø± Ø§Ù„Ø¬Ø±Ø§Ù… / Ø§Ù„Ù…Ù„ / Ø§Ù„Ø­Ø¨Ø©

  ing.push({n, basePrice, baseUnit});
  renderIng();
  updateAllLookupsAndUnits();

  document.getElementById('name').value='';
  document.getElementById('qty').value='';
  document.getElementById('price').value='';
}

function renderIng(){
  const tbl = document.getElementById('ingTbl');
  let header = '<tr><th>Ø§Ù„Ù…Ø§Ø¯Ø©</th><th>Ø§Ù„ÙˆØ­Ø¯Ø© Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ©</th><th>Ø³Ø¹Ø± Ø§Ù„ÙˆØ­Ø¯Ø© Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ©</th><th>Ø­Ø°Ù</th></tr>';
  let rows = ing.map((i,idx) => {
    let label = i.baseUnit;
    if(label === 'g') label = 'Ø¬Ø±Ø§Ù… (g)';
    else if(label === 'ml') label = 'Ù…Ù„ (ml)';
    else if(label === 'pc') label = 'Ø­Ø¨Ø© (Pc)';
    return `
    <tr>
      <td>${i.n}</td>
      <td>${label}</td>
      <td>${i.basePrice.toFixed(4)} Ø±ÙŠØ§Ù„ / ${i.baseUnit}</td>
      <td><button class="secondary" onclick="deleteIngredient(${idx})">Ø­Ø°Ù</button></td>
    </tr>`;
  }).join('');
  tbl.innerHTML = header + rows;
}

function deleteIngredient(index){
  if(!confirm('Ø­Ø°Ù Ù‡Ø°Ù‡ Ø§Ù„Ù…Ø§Ø¯Ø© Ø³ÙŠØ¤Ø«Ø± Ø¹Ù„Ù‰ Ø§Ù„Ø®Ù„Ø·Ø§Øª ÙˆØ§Ù„Ù…Ù†ØªØ¬Ø§Øª Ø§Ù„Ù…Ø±ØªØ¨Ø·Ø© Ø¨Ù‡Ø§. Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ØŸ')) return;
  ing.splice(index,1);
  renderIng();
  recalcMixes();
  calcProducts();
  updateAllLookupsAndUnits();
}

/************ ØµÙØ­Ø© Ø§Ù„Ø®Ù„Ø·Ø§Øª - Ù†Ø¸Ø§Ù… Ø§Ù„Ø¨Ù„ÙˆÙƒØ§Øª ************/

function addMixBlock(mixData){
  const container = document.getElementById('mixesContainer');
  const block = document.createElement('div');
  block.className = 'mix-block';
  const nameVal = mixData && mixData.mixName ? mixData.mixName : '';
  block.innerHTML = `
    <div class="mix-header">
      <div class="mix-header-left">
        <span class="small">Ø§Ø³Ù… Ø§Ù„Ø®Ù„Ø·Ø©:</span>
        <input class="mix-name" placeholder="Ù…Ø«Ø§Ù„: Ø®Ù„Ø·Ø© Ø³ÙŠØ±Ø¨ Ø³Ø¨Ø§Ù†ÙŠØ´" value="${nameVal}" oninput="recalcMixes()">
      </div>
      <button class="secondary" onclick="deleteMixBlock(this)">Ø­Ø°Ù Ø§Ù„Ø®Ù„Ø·Ø© Ø¨Ø§Ù„ÙƒØ§Ù…Ù„</button>
    </div>
    <table>
      <tr><th>Ø§Ù„Ù…Ø§Ø¯Ø© (Ù…Ù† Ø§Ù„Ù…Ø®Ø²ÙˆÙ†)</th><th>Ø§Ù„ÙƒÙ…ÙŠØ©</th><th>Ø§Ù„ØªÙƒÙ„ÙØ©</th><th>Ø­Ø°Ù</th></tr>
    </table>
    <div class="btn-row">
      <button class="secondary" onclick="addMixItemRow(this)">+ Ø¥Ø¶Ø§ÙØ© Ù…Ø§Ø¯Ø© Ø®Ø§Ù…</button>
    </div>
    <div class="mix-total-line">Ø¥Ø¬Ù…Ø§Ù„ÙŠ ØªÙƒÙ„ÙØ© Ù‡Ø°Ù‡ Ø§Ù„Ø®Ù„Ø·Ø©: <span class="mix-total">0.00</span> Ø±ÙŠØ§Ù„</div>
  `;
  container.appendChild(block);

  if(mixData && Array.isArray(mixData.items) && mixData.items.length>0){
    mixData.items.forEach(it=>{
      addMixItemRow(block.querySelector('.btn-row button'), it);
    });
  }else{
    addMixItemRow(block.querySelector('.btn-row button'));
  }
  recalcMixes();
}

function deleteMixBlock(btn){
  if(!confirm('Ø­Ø°Ù Ù‡Ø°Ù‡ Ø§Ù„Ø®Ù„Ø·Ø© Ø³ÙŠØ¤Ø«Ø± Ø¹Ù„Ù‰ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª Ø§Ù„ØªÙŠ ØªØ³ØªØ®Ø¯Ù…Ù‡Ø§. Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ØŸ')) return;
  const block = btn.closest('.mix-block');
  block.parentNode.removeChild(block);
  recalcMixes();
}

function addMixItemRow(btn, itemData){
  const block = btn.closest('.mix-block');
  const table = block.querySelector('table');
  const tr = document.createElement('tr');
  const nameVal = itemData && itemData.material ? itemData.material : '';
  const qtyVal  = itemData && itemData.qty  ? itemData.qty  : '';
  tr.innerHTML = `
    <td>
      <input class="mixNameInput" placeholder="Ø§ÙƒØªØ¨ Ø§Ø³Ù… Ø§Ù„Ù…Ø§Ø¯Ø© Ø«Ù… Ø§Ø®ØªØ± Ù…Ù† Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©" list="ingList" value="${nameVal || ''}" oninput="recalcMixes(); updateMixItemUnit(this)">
      <div class="error-text mix-name-error" style="display:none;"></div>
    </td>
    <td>
      <input type="number" value="${qtyVal || ''}" oninput="recalcMixes()">
      <span class="unit-label"></span>
    </td>
    <td class="c">0.00</td>
    <td><button class="secondary" onclick="deleteMixItemRow(this)">Ø­Ø°Ù</button></td>
  `;
  table.appendChild(tr);
  updateMixItemUnit(tr.querySelector('.mixNameInput'));
  recalcMixes();
}

function deleteMixItemRow(btn){
  const tr = btn.closest('tr');
  tr.parentNode.removeChild(tr);
  recalcMixes();
}

function updateMixItemUnit(input){
  const tr = input.closest('tr');
  const name = (input.value || '').trim();
  const unitSpan = tr.querySelector('.unit-label');
  const item = ing.find(x=>x.n===name);
  if(item){
    let label = item.baseUnit;
    if(label === 'g') label = 'Ø¬Ø±Ø§Ù… (g)';
    else if(label === 'ml') label = 'Ù…Ù„ (ml)';
    else if(label === 'pc') label = 'Ø­Ø¨Ø© (Pc)';
    unitSpan.textContent = label;
  }else{
    unitSpan.textContent = '';
  }
}

function recalcMixes(){
  const mixBlocks = document.querySelectorAll('.mix-block');
  let mixMap = {}; // name -> {totalCost, items:[]}

  mixBlocks.forEach(block=>{
    block.classList.remove('bad');
    const nameInput = block.querySelector('.mix-name');
    const mixTotalSpan = block.querySelector('.mix-total');
    const rows = block.querySelectorAll('table tr');

    const mixName = nameInput.value.trim();
    let mixTotalCost = 0;
    let mixHasError = false;
    let mixItems = [];

    // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ø³Ù… Ø§Ù„Ø®Ù„Ø·Ø©
    if(!mixName){
      mixHasError = true;
    }

    rows.forEach((tr,idx)=>{
      if(idx===0) return; // ØªØ®Ø·ÙŠ Ø§Ù„Ø±Ø£Ø³
      tr.classList.remove('bad');
      const matInput = tr.querySelector('.mixNameInput');
      const err = tr.querySelector('.mix-name-error');
      const qtyInput = tr.querySelector('td:nth-child(2) input');
      const costCell = tr.querySelector('td:nth-child(3)');

      err.style.display = 'none';
      err.textContent = '';

      const matName = (matInput.value || '').trim();
      const qty = parseFloat(qtyInput.value) || 0;

      if(!matName || qty<=0){
        costCell.textContent = '0.00';
        return;
      }
      const item = ing.find(x=>x.n===matName);
      if(!item){
        costCell.textContent = '0.00';
        tr.classList.add('bad');
        err.textContent = 'Ø§Ù„Ù…Ø§Ø¯Ø© ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯Ø© ÙÙŠ Ø§Ù„Ù…Ø®Ø²ÙˆÙ†. Ø§Ø®ØªØ± Ù…Ù† Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©.';
        err.style.display = 'block';
        mixHasError = true;
        return;
      }
      const cost = item.basePrice * qty;
      costCell.textContent = cost.toFixed(2);
      mixTotalCost += cost;
      mixItems.push({material:matName, qty:qty});
    });

    if(mixHasError){
      mixTotalSpan.textContent = 'Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø­Ø³Ø§Ø¨ Ø£Ùˆ Ø§Ø³Ù… Ø§Ù„Ø®Ù„Ø·Ø© ÙØ§Ø±Øº';
      block.classList.add('bad');
    }else{
      mixTotalSpan.textContent = mixTotalCost.toFixed(2);
      block.classList.remove('bad');
      // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø®Ø±ÙŠØ·Ø© ÙÙ‚Ø· Ù„Ù„Ø®Ù„Ø·Ø§Øª Ø§Ù„Ø³Ù„ÙŠÙ…Ø©
      mixMap[mixName] = {totalCost: mixTotalCost, items: mixItems};
    }
  });

  // ØªØ­Ø¯ÙŠØ« Ù…ØµÙÙˆÙØ© mixes Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠØ©
  const newMixes = [];
  Object.keys(mixMap).forEach(name=>{
    const prev = mixes.find(m=>m.name === name);
    newMixes.push({
      name,
      totalCost: mixMap[name].totalCost,
      items: mixMap[name].items,
      totalWeight: prev ? prev.totalWeight : 0,
      unit: prev ? prev.unit : 'ml'
    });
  });
  mixes = newMixes;

  renderMixSummary();
  updateAllLookupsAndUnits();
  calcProducts();
}

function renderMixSummary(){
  const tbl = document.getElementById('mixSummary');
  let header = `
    <tr>
      <th>Ø§Ø³Ù… Ø§Ù„Ø®Ù„Ø·Ø©</th>
      <th>Ø¥Ø¬Ù…Ø§Ù„ÙŠ ØªÙƒÙ„ÙØ© Ø§Ù„Ø®Ù„Ø·Ø© (Ø±ÙŠØ§Ù„)</th>
      <th>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„ÙˆØ²Ù†</th>
      <th>Ø§Ù„ÙˆØ­Ø¯Ø©</th>
      <th>ØªÙƒÙ„ÙØ© Ø§Ù„ÙˆØ­Ø¯Ø© (Ø±ÙŠØ§Ù„ / Ù…Ù„ Ø£Ùˆ Ø¬Ø±Ø§Ù…)</th>
    </tr>`;
  let rows = mixes.map((m,idx)=>{
    const w = m.totalWeight || 0;
    const costPerUnit = (w > 0) ? (m.totalCost / w) : 0;
    const unitLabel = m.unit === 'g' ? 'Ø¬Ø±Ø§Ù…' : 'Ù…Ù„';
    return `
      <tr>
        <td>${m.name}</td>
        <td>${m.totalCost.toFixed(2)}</td>
        <td>
          <input type="number" value="${w || ''}" oninput="changeMixWeight(${idx}, this.value)" placeholder="Ù…Ø«Ø§Ù„: 700">
        </td>
        <td>
          <select onchange="changeMixUnit(${idx}, this.value)">
            <option value="ml"${m.unit==='ml'?' selected':''}>Ù…Ù„</option>
            <option value="g"${m.unit==='g'?' selected':''}>Ø¬Ø±Ø§Ù…</option>
          </select>
        </td>
        <td>${costPerUnit > 0 ? costPerUnit.toFixed(4) + ' Ø±ÙŠØ§Ù„ / ' + unitLabel : '-'}</td>
      </tr>`;
  }).join('');
  tbl.innerHTML = header + rows;
}

function changeMixWeight(idx, val){
  const w = parseFloat(val) || 0;
  mixes[idx].totalWeight = w;
  renderMixSummary();
  calcProducts();
}

function changeMixUnit(idx, val){
  if(val !== 'ml' && val !== 'g') val = 'ml';
  mixes[idx].unit = val;
  renderMixSummary();
  calcProducts();
}

/************ Ù‚ÙˆØ§Ø¦Ù… Ø§Ù„Ø¨Ø­Ø« (datalist) ************/
function updateLookups(){
  const ingList = document.getElementById('ingList');
  const mixList = document.getElementById('mixList');
  ingList.innerHTML = '';
  mixList.innerHTML = '';

  ing.forEach(i=>{
    const opt = document.createElement('option');
    opt.value = i.n;
    ingList.appendChild(opt);
  });

  // ÙÙ‚Ø· Ø§Ù„Ø®Ù„Ø·Ø§Øª Ø§Ù„ØªÙŠ Ù„Ø§ ØªØ­ØªÙˆÙŠ Ø¹Ù„Ù‰ Ø®Ø·Ø£ ØªØ¸Ù‡Ø± ÙÙŠ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø¨Ø­Ø«
  mixes.forEach(m=>{
    // ØªØ­Ù‚Ù‚ Ù…Ù† Ø£Ù† Ø§Ù„Ø®Ù„Ø·Ø© ØªÙ… Ø­Ø³Ø§Ø¨Ù‡Ø§ Ø¨Ù†Ø¬Ø§Ø­ (Ø¥Ø°Ø§ ÙƒØ§Ù†Øª Ø§Ù„ØªÙƒÙ„ÙØ© Ø£ÙƒØ¨Ø± Ù…Ù† ØµÙØ±ØŒ ÙÙ‡ÙŠ Ù…Ø­Ø³ÙˆØ¨Ø© Ù…Ù† Ù…ÙˆØ§Ø¯ ØµØ­ÙŠØ­Ø©)
    if(m.totalCost > 0){
        const opt = document.createElement('option');
        opt.value = m.name;
        mixList.appendChild(opt);
    }
  });
}

function updateAllLookupsAndUnits(){
  updateLookups();
  const prodBlocks = document.querySelectorAll('.product-block');
  prodBlocks.forEach(block=>{
    const rows = block.querySelectorAll('table tr');
    rows.forEach((tr,idx)=>{
      if(idx===0) return;
      updateRowUnit(tr);
    });
  });
  refreshSalesProductList(); // ØªØ­Ø¯ÙŠØ« Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø¨Ø­Ø« Ù„Ù„Ù…Ø¨ÙŠØ¹Ø§Øª
}

/************ ØµÙØ­Ø© Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª / Ø§Ù„ÙˆØµÙØ§Øª ************/
function addProductBlock(prodData){
  const container = document.getElementById('productsContainer');
  const block = document.createElement('div');
  block.className = 'product-block';
  const nameVal = prodData && prodData.product ? prodData.product : '';
  block.innerHTML = `
    <div class="prod-header">
      <div class="prod-header-left">
        <span class="small">Ø§Ø³Ù… Ø§Ù„Ù…Ù†ØªØ¬:</span>
        <input class="prod-name" placeholder="Ù…Ø«Ø§Ù„: ÙƒØ§Ø¨ØªØ´ÙŠÙ†Ùˆ" value="${nameVal}" oninput="calcProducts()">
      </div>
      <button class="secondary" onclick="deleteProductBlock(this)">Ø­Ø°Ù Ø§Ù„Ù…Ù†ØªØ¬ Ø¨Ø§Ù„ÙƒØ§Ù…Ù„</button>
    </div>
    <table>
      <tr><th>Ø§Ù„Ù†ÙˆØ¹</th><th>Ø§Ù„Ø§Ø³Ù… (Ø¨Ø­Ø«)</th><th>Ø§Ù„ÙƒÙ…ÙŠØ©</th><th>Ø§Ù„ØªÙƒÙ„ÙØ©</th><th>Ø­Ø°Ù</th></tr>
    </table>
    <div class="btn-row">
      <button class="secondary" onclick="addItemRow(this)">+ Ø¥Ø¶Ø§ÙØ© Ù…Ø§Ø¯Ø© / Ø®Ù„Ø·Ø©</button>
    </div>
    <div class="prod-total-line">Ø¥Ø¬Ù…Ø§Ù„ÙŠ ØªÙƒÙ„ÙØ© Ù‡Ø°Ø§ Ø§Ù„Ù…Ù†ØªØ¬: <span class="prod-total">0.00</span> Ø±ÙŠØ§Ù„</div>
  `;
  container.appendChild(block);

  if(prodData && Array.isArray(prodData.items) && prodData.items.length>0){
    prodData.items.forEach(it=>{
      addItemRow(block.querySelector('.btn-row button'), it);
    });
  }else{
    addItemRow(block.querySelector('.btn-row button'));
  }
  calcProducts();
}

function deleteProductBlock(btn){
  if(!confirm('Ø­Ø°Ù Ù‡Ø°Ø§ Ø§Ù„Ù…Ù†ØªØ¬ Ø³ÙŠØ­Ø°Ù Ø¬Ù…ÙŠØ¹ Ù…ÙˆØ§Ø¯Ù‡. Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ØŸ')) return;
  const block = btn.closest('.product-block');
  block.parentNode.removeChild(block);
  calcProducts();
}

function addItemRow(btn, itemData){
  const block = btn.closest('.product-block');
  const table = block.querySelector('table');
  const tr = document.createElement('tr');
  const typeVal = itemData && itemData.type ? itemData.type : 'ing';
  const nameVal = itemData && itemData.name ? itemData.name : '';
  const qtyVal  = itemData && itemData.qty  ? itemData.qty  : '';
  tr.innerHTML = `
    <td>
      <select class="typeSelect" onchange="onTypeChangeRow(this)">
        <option value="ing"${typeVal==='ing'?' selected':''}>Ù…Ø§Ø¯Ø© Ù…Ø®Ø²ÙˆÙ†</option>
        <option value="mix"${typeVal==='mix'?' selected':''}>Ø®Ù„Ø·Ø©</option>
      </select>
      <div class="error-text type-error" style="display:none;"></div>
    </td>
    <td>
      <input class="nameInput" placeholder="Ø§ÙƒØªØ¨ Ø£ÙˆÙ„ Ø§Ù„Ø§Ø³Ù… Ø«Ù… Ø§Ø®ØªØ± Ù…Ù† Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©" list="" value="${nameVal || ''}" oninput="onNameInput(this)">
      <div class="error-text name-error" style="display:none;"></div>
    </td>
    <td>
      <input type="number" value="${qtyVal || ''}" oninput="calcProducts()">
      <span class="unit-label"></span>
    </td>
    <td class="c">0.00</td>
    <td><button class="secondary" onclick="deleteItemRow(this)">Ø­Ø°Ù</button></td>
  `;
  table.appendChild(tr);
  updateNameInputList(tr);
  updateRowUnit(tr);
  calcProducts();
}

function deleteItemRow(btn){
  const tr = btn.closest('tr');
  tr.parentNode.removeChild(tr);
  calcProducts();
}

/************ ØªÙ‡ÙŠØ¦Ø© Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø¨Ø­Ø« Ø­Ø³Ø¨ Ø§Ù„Ù†ÙˆØ¹ ************/
function onTypeChangeRow(sel){
  const tr = sel.closest('tr');
  updateNameInputList(tr);
  updateRowUnit(tr);
  calcProducts();
}

function updateNameInputList(tr){
  const typeSel = tr.querySelector('.typeSelect');
  const nameInput = tr.querySelector('.nameInput');
  if(!typeSel || !nameInput) return;
  const typeVal = typeSel.value;
  if(typeVal === 'ing'){
    nameInput.setAttribute('list', 'ingList');
  }else{
    nameInput.setAttribute('list', 'mixList');
  }
}

function onNameInput(input){
  const tr = input.closest('tr');
  updateRowUnit(tr);
  calcProducts();
}

/************ ØªØ­Ø¯ÙŠØ« ÙˆØ­Ø¯Ø© Ø§Ù„ÙƒÙ…ÙŠØ© ************/
function updateRowUnit(tr){
  const typeSel = tr.querySelector('.typeSelect');
  const nameInput = tr.querySelector('.nameInput');
  const unitSpan = tr.querySelector('.unit-label');
  if(!typeSel || !nameInput || !unitSpan) return;
  const typeVal = typeSel.value;
  const name = (nameInput.value || '').trim();
  if(!name){
    unitSpan.textContent = '';
    return;
  }

  if(typeVal === 'ing'){
    const item = ing.find(x=>x.n===name);
    if(!item){ unitSpan.textContent = ''; return; }
    let label = item.baseUnit;
    if(label === 'g') label = 'Ø¬Ø±Ø§Ù… (g)';
    else if(label === 'ml') label = 'Ù…Ù„ (ml)';
    else if(label === 'pc') label = 'Ø­Ø¨Ø© (Pc)';
    unitSpan.textContent = label;
  }else{
    const mix = mixes.find(m=>m.name===name);
    if(!mix){ unitSpan.textContent = ''; return; }
    unitSpan.textContent = mix.unit === 'g' ? 'Ø¬Ø±Ø§Ù… (g)' : 'Ù…Ù„ (ml)';
  }
}

/************ Ø­Ø³Ø§Ø¨ Ø§Ù„ØªÙƒØ§Ù„ÙŠÙ Ù„ÙƒÙ„ Ù…Ù†ØªØ¬ ÙˆÙ„ÙƒÙ„ Ø§Ù„Ù†Ø¸Ø§Ù… ***********om************/
function calcProducts(){
  const prodBlocks = document.querySelectorAll('.product-block');
  let grandTotal = 0;
  let productMap = {}; // Ø§Ø³Ù… Ø§Ù„Ù…Ù†ØªØ¬ -> Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„ØªÙƒÙ„ÙØ©

  prodBlocks.forEach(block=>{
    block.classList.remove('bad');
    const prodNameInput = block.querySelector('.prod-name');
    const prodName = (prodNameInput.value || '').trim();
    const rows = block.querySelectorAll('table tr');
    let productTotal = 0;
    let productHasError = false;

    if(!prodName){
      productHasError = true;
    }

    rows.forEach((tr,idx)=>{
      if(idx===0 || productHasError) return;
      tr.classList.remove('bad');
      const typeSel = tr.querySelector('.typeSelect');
      const nameInput = tr.querySelector('.nameInput');
      const qtyInput = tr.querySelector('td:nth-child(3) input');
      const cell = tr.querySelector('td:nth-child(4)');
      const nameError = tr.querySelector('.name-error');

      nameError.style.display = 'none';
      nameError.textContent = '';

      const typeVal = typeSel.value;
      const name = (nameInput.value || '').trim();
      const qty = parseFloat(qtyInput.value) || 0;

      if(qty > 0 && !name){
        cell.textContent = '0.00';
        tr.classList.add('bad');
        nameError.textContent = 'ÙŠØ¬Ø¨ Ø§Ø®ØªÙŠØ§Ø± Ù…Ø§Ø¯Ø© Ø£Ùˆ Ø®Ù„Ø·Ø© ØµØ­ÙŠØ­Ø© Ù…Ù† Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©';
        nameError.style.display = 'block';
        productHasError = true;
        return;
      }

      if(!name || qty<=0){
        cell.textContent = '0.00';
        return;
      }

      let costPerUnit = 0;
      if(typeVal === 'ing'){
        const item = ing.find(x=>x.n===name);
        if(!item){
          cell.textContent='0.00';
          tr.classList.add('bad');
          nameError.textContent = 'Ù‡Ø°Ù‡ Ø§Ù„Ù…Ø§Ø¯Ø© ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯Ø© ÙÙŠ Ø§Ù„Ù…Ø®Ø²ÙˆÙ†';
          nameError.style.display = 'block';
          productHasError = true;
          return;
        }
        costPerUnit = item.basePrice;
      }else{
        const mix = mixes.find(m=>m.name===name);
        if(!mix){
          cell.textContent='0.00';
          tr.classList.add('bad');
          nameError.textContent = 'Ù‡Ø°Ù‡ Ø§Ù„Ø®Ù„Ø·Ø© ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯Ø© ÙÙŠ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø®Ù„Ø·Ø§Øª';
          nameError.style.display = 'block';
          productHasError = true;
          return;
        }
        if(!mix.totalWeight || mix.totalWeight<=0){
          cell.textContent='0.00';
          tr.classList.add('bad');
          nameError.textContent = 'Ø£Ø¯Ø®Ù„ ÙˆØ²Ù† Ø§Ù„Ø®Ù„Ø·Ø© ÙÙŠ ØµÙØ­Ø© Ø§Ù„Ø®Ù„Ø·Ø§Øª Ø£ÙˆÙ„Ø§Ù‹';
          nameError.style.display = 'block';
          productHasError = true;
          return;
        }
        costPerUnit = mix.totalCost / mix.totalWeight;
      }

      const cost = costPerUnit * qty;
      cell.textContent = cost.toFixed(2);
      productTotal += cost;
    });

    const prodTotalSpan = block.querySelector('.prod-total');
    if(productHasError){
      prodTotalSpan.textContent = 'Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø­Ø³Ø§Ø¨ Ø£Ùˆ Ø§Ø³Ù… Ø§Ù„Ù…Ù†ØªØ¬ ÙØ§Ø±Øº';
      block.classList.add('bad');
    }else{
      prodTotalSpan.textContent = productTotal.toFixed(2);
      grandTotal += productTotal;
      block.classList.remove('bad');
      if(prodName){
        productMap[prodName] = productTotal;
      }
    }
  });

  document.getElementById('total').textContent = grandTotal.toFixed(2);
  renderProductSummary(productMap);
  refreshSalesProductList();
}

function renderProductSummary(productMap){
  const tbl = document.getElementById('productSummary');
  let header = '<tr><th>Ø§Ø³Ù… Ø§Ù„Ù…Ù†ØªØ¬</th><th>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„ØªÙƒÙ„ÙØ© (Ø±ÙŠØ§Ù„)</th></tr>';
  let rows = Object.keys(productMap).map(name=>`
    <tr>
      <td>${name}</td>
      <td>${productMap[name].toFixed(2)}</td>
    </tr>`).join('');
  tbl.innerHTML = header + rows;
}

/************ ØªØµØ¯ÙŠØ± / Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ************/
function exportData(){
  const prodBlocks = document.querySelectorAll('.product-block');
  const recipes = [];

  prodBlocks.forEach(block=>{
    const prodName = (block.querySelector('.prod-name').value || '').trim();
    const rows = block.querySelectorAll('table tr');
    const items = [];
    rows.forEach((tr,idx)=>{
      if(idx===0) return;
      const typeSel = tr.querySelector('.typeSelect');
      const nameInput = tr.querySelector('.nameInput');
      const qtyInput = tr.querySelector('td:nth-child(3) input');
      items.push({
        type: typeSel.value,
        name: nameInput.value,
        qty: qtyInput.value
      });
    });
    recipes.push({product: prodName, items});
  });

  // Ø­ÙØ¸ Ù‡ÙŠÙƒÙ„Ø© Ø§Ù„Ø®Ù„Ø·Ø§Øª Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©
  const mixBlocks = document.querySelectorAll('.mix-block');
  const mixRecipes = [];
  mixBlocks.forEach(block=>{
    const mixName = (block.querySelector('.mix-name').value || '').trim();
    const rows = block.querySelectorAll('table tr');
    const items = [];
    rows.forEach((tr,idx)=>{
      if(idx===0) return;
      const nameInput = tr.querySelector('.mixNameInput');
      const qtyInput = tr.querySelector('td:nth-child(2) input');
      items.push({
        material: nameInput.value,
        qty: qtyInput.value
      });
    });
    mixRecipes.push({mixName: mixName, items});
  });

  const data = {
    ingredients: ing,
    mixes: mixes, // ØªØ­ØªÙˆÙŠ Ø¹Ù„Ù‰ totalWeight Ùˆ unit
    mixRecipes: mixRecipes, // ØªØ­ØªÙˆÙŠ Ø¹Ù„Ù‰ Ø§Ù„Ù…ÙƒÙˆÙ†Ø§Øª Ø§Ù„ÙØ¹Ù„ÙŠØ© Ù„Ù„Ø®Ù„Ø·Ø§Øª
    recipes: recipes
  };

  const blob = new Blob([JSON.stringify(data,null,2)], {type:'application/json'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = 'cost_data.json';
  document.body.appendChild(a);
  a.click();
  document.body.removeChild(a);
  URL.revokeObjectURL(url);
}

document.getElementById('fileInput').addEventListener('change', function(e){
  const file = e.target.files[0];
  if(!file) return;
  const reader = new FileReader();
  reader.onload = function(evt){
    try{
      const data = JSON.parse(evt.target.result);
      if(Array.isArray(data.ingredients)){
        ing = data.ingredients;
        renderIng();
      }

      // Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ø§Ù„Ø®Ù„Ø·Ø§Øª Ø¨Ø§Ù„Ù‡ÙŠÙƒÙ„Ø© Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©
      const mixContainer = document.getElementById('mixesContainer');
      mixContainer.innerHTML = '';
      if(Array.isArray(data.mixRecipes) && data.mixRecipes.length > 0){
        data.mixRecipes.forEach(mix=>{
          addMixBlock(mix);
        });
      }else{
        // Ø¥Ø°Ø§ ÙƒØ§Ù† Ù…Ù„Ù Ù‚Ø¯ÙŠÙ…ØŒ Ù‚Ù… Ø¨Ø¥Ù†Ø´Ø§Ø¡ Ø¨Ù„ÙˆÙƒ ÙØ§Ø±Øº
        addMixBlock();
      }

      // Ø§Ø³ØªØ¹Ø§Ø¯Ø© Ø§Ù„Ø£ÙˆØ²Ø§Ù† ÙˆØ§Ù„ÙˆØ­Ø¯Ø§Øª Ù„Ù„Ø®Ù„Ø·Ø§Øª
      if(Array.isArray(data.mixes)){
        data.mixes.forEach(saved=>{
          const m = mixes.find(x=>x.name===saved.name);
          if(m){
            m.totalWeight = saved.totalWeight || 0;
            m.unit = saved.unit || 'ml';
          }
        });
      }
      recalcMixes(); // Ù„Ø¥Ø¹Ø§Ø¯Ø© Ø­Ø³Ø§Ø¨ Ø§Ù„ØªÙƒÙ„ÙØ© ÙˆØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…Ù„Ø®Øµ

      // Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª
      const prodContainer = document.getElementById('productsContainer');
      prodContainer.innerHTML = '';
      if(Array.isArray(data.recipes) && data.recipes.length > 0){
        data.recipes.forEach(prod=>{
          addProductBlock(prod);
        });
      }else{
        addProductBlock();
      }

      updateAllLookupsAndUnits();
      calcProducts();
    }catch(err){
      alert('Ù…Ù„Ù ØºÙŠØ± ØµØ§Ù„Ø­');
      const container = document.getElementById('productsContainer');
      container.innerHTML = '';
      addProductBlock();
    }
  };
  reader.readAsText(file);
  e.target.value = '';
});

/************ ØªØµØ¯ÙŠØ± ØªÙ‚Ø±ÙŠØ± PDF ************/
function exportPDF(){
  calcProducts();
  const prodBlocks = document.querySelectorAll('.product-block:not(.bad)');
  if(prodBlocks.length === 0){
    alert('Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù…Ù†ØªØ¬Ø§Øª ØµØ§Ù„Ø­Ø© Ù„Ø¹Ù…Ù„ ØªÙ‚Ø±ÙŠØ±. ØªØ£ÙƒØ¯ Ù…Ù† Ø£Ù† Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…ÙƒÙˆÙ†Ø§Øª ØµØ­ÙŠØ­Ø©.');
    return;
  }

  let html = '<h2 style="text-align:center;margin-bottom:4px;">ØªÙ‚Ø±ÙŠØ± ØªÙƒÙ„ÙØ© Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª</h2>';
  html += '<p style="text-align:center;font-size:11px;color:#555;margin-top:0;">Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª Ø§Ù„ØªÙŠ ØªØ­ØªÙˆÙŠ Ø¹Ù„Ù‰ Ø£Ø®Ø·Ø§Ø¡ ÙÙŠ Ø§Ù„Ù…ÙƒÙˆÙ†Ø§Øª Ù„Ø§ ÙŠØªÙ… Ø¥Ø¯Ø±Ø§Ø¬Ù‡Ø§ ÙÙŠ Ø§Ù„ØªÙ‚Ø±ÙŠØ±.</p>';

  prodBlocks.forEach((block)=>{
    const prodName = (block.querySelector('.prod-name').value || '').trim() || 'Ù…Ù†ØªØ¬ Ø¨Ø¯ÙˆÙ† Ø§Ø³Ù…';
    const rows = block.querySelectorAll('table tr');
    const prodTotal = block.querySelector('.prod-total').textContent || '0.00';

    html += '<hr style="border:none;border-top:1px solid #ddd;margin:12px 0;">';
    html += '<h3 style="margin:0 0 4px 0;">'+ prodName +'</h3>';
    html += '<table style="width:100%;border-collapse:collapse;font-size:11px;margin-top:4px;">';
    html += '<tr>'+
              '<th style="border:1px solid #ddd;padding:4px;">Ø§Ù„Ù†ÙˆØ¹</th>'+
              '<th style="border:1px solid #ddd;padding:4px;">Ø§Ù„Ø§Ø³Ù…</th>'+
              '<th style="border:1px solid #ddd;padding:4px;">Ø§Ù„ÙƒÙ…ÙŠØ©</th>'+
              '<th style="border:1px solid #ddd;padding:4px;">Ø§Ù„ÙˆØ­Ø¯Ø©</th>'+
              '<th style="border:1px solid #ddd;padding:4px;">Ø§Ù„ØªÙƒÙ„ÙØ© (Ø±ÙŠØ§Ù„)</th>'+
            '</tr>';

    rows.forEach((tr, rIdx)=>{
      if(rIdx===0) return;
      const typeSel = tr.querySelector('.typeSelect');
      const nameInput = tr.querySelector('.nameInput');
      const qtyInput = tr.querySelector('td:nth-child(3) input');
      const unitSpan = tr.querySelector('.unit-label');
      const costCell = tr.querySelector('td:nth-child(4)');

      const name = (nameInput.value || '').trim();
      const qty = qtyInput.value || '';
      const cost = costCell.textContent || '0.00';
      const typeText = typeSel.value === 'ing' ? 'Ù…Ø§Ø¯Ø© Ù…Ø®Ø²ÙˆÙ†' : 'Ø®Ù„Ø·Ø©';
      const unitText = unitSpan.textContent.replace(/\s*\(.*\)/, '');

      if(!name || !qty || parseFloat(qty)<=0 || tr.classList.contains('bad')) return;

      html += '<tr>'+
                '<td style="border:1px solid #ddd;padding:4px;">'+ typeText +'</td>'+
                '<td style="border:1px solid #ddd;padding:4px;">'+ name +'</td>'+
                '<td style="border:1px solid #ddd;padding:4px;">'+ qty +'</td>'+
                '<td style="border:1px solid #ddd;padding:4px;">'+ unitText +'</td>'+
                '<td style="border:1px solid #ddd;padding:4px;">'+ cost +'</td>'+
              '</tr>';
    });

    html += '<tr>'+
              '<td colspan="4" style="border:1px solid #ddd;padding:4px;text-align:left;font-weight:bold;">Ø¥Ø¬Ù…Ø§Ù„ÙŠ ØªÙƒÙ„ÙØ© Ø§Ù„Ù…Ù†ØªØ¬</td>'+
              '<td style="border:1px solid #ddd;padding:4px;font-weight:bold;">'+ prodTotal +'</td>'+
            '</tr>';

    html += '</table>';
  });

  const grandTotal = document.getElementById('total').textContent || '0.00';
  html += '<hr style="border:none;border-top:1px solid #ddd;margin:14px 0;">';
  html += '<p style="text-align:left;font-size:12px;"><b>Ø¥Ø¬Ù…Ø§Ù„ÙŠ ØªÙƒÙ„ÙØ© ÙƒÙ„ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª Ø§Ù„ØµØ§Ù„Ø­Ø©:</b> '+ grandTotal +' Ø±ÙŠØ§Ù„</p>';

  const win = window.open('', '_blank', 'width=900,height=700');
  win.document.write('<html><head><meta charset="UTF-8"><title>ØªÙ‚Ø±ÙŠØ± ØªÙƒÙ„ÙØ© Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª</title>');
  win.document.write('<style>body{font-family:Arial,Helvetica,sans-serif;direction:rtl;margin:20px;} h2,h3{font-family:Arial,Helvetica,sans-serif;} table{page-break-inside:auto;} tr{page-break-inside:avoid;page-break-after:auto;}</style>');
  win.document.write('</head><body>'+html+'</body></html>');
  win.document.close();
  win.focus();
  win.print();
}

/************ ØµÙØ­Ø© Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª ÙˆØ§Ø³ØªÙ‡Ù„Ø§Ùƒ Ø§Ù„Ù…ÙˆØ§Ø¯ ************/
function refreshSalesProductList(){
  const dataList = document.getElementById('salesProdList');
  if(!dataList) return;
  dataList.innerHTML = '';
  // ÙÙ‚Ø· Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª Ø§Ù„ØµØ§Ù„Ø­Ø© (Ù„ÙŠØ³Øª BAD) ØªØ¸Ù‡Ø± ÙÙŠ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª
  const prodBlocks = document.querySelectorAll('.product-block:not(.bad)');
  const names = [];
  prodBlocks.forEach(block=>{
    const nameInput = block.querySelector('.prod-name');
    const name = (nameInput && nameInput.value || '').trim();
    if(name && !names.includes(name)){
      names.push(name);
    }
  });
  names.forEach(n=>{
    const opt = document.createElement('option');
    opt.value = n;
    dataList.appendChild(opt);
  });
}

function addSalesRow(prodName='', qtyVal=''){
  const tbl = document.getElementById('salesTbl');
  if(!tbl) return;
  const tr = document.createElement('tr');
  tr.innerHTML = `
    <td>
      <input class="sales-prod-name" placeholder="Ø§ÙƒØªØ¨ Ø§Ø³Ù… Ø§Ù„Ù…Ù†ØªØ¬ ÙƒÙ…Ø§ ÙÙŠ ØµÙØ­Ø© Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª" list="salesProdList" value="${prodName || ''}" oninput="/* ÙÙ‚Ø· ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø§Ø³Ù… */">
    </td>
    <td>
      <input class="sales-qty" type="number" min="0" step="1" value="${qtyVal || ''}">
    </td>
    <td class="sales-note"></td>
    <td><button class="secondary" onclick="deleteSalesRow(this)">Ø­Ø°Ù</button></td>
  `;
  tbl.appendChild(tr);
}

function deleteSalesRow(btn){
  const tr = btn.closest('tr');
  tr.parentNode.removeChild(tr);
}

function clearSalesRows(){
  const tbl = document.getElementById('salesTbl');
  if(!tbl) return;
  const rows = Array.from(tbl.querySelectorAll('tr')).slice(1);
  rows.forEach(r=>r.remove());
  const sumTbl = document.getElementById('salesSummary');
  if(sumTbl){
    sumTbl.innerHTML = '<tr><th>Ø§Ø³Ù… Ø§Ù„Ù…Ø§Ø¯Ø©</th><th>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„ÙƒÙ…ÙŠØ© Ø§Ù„Ù…Ø³ØªÙ‡Ù„ÙƒØ©</th><th>Ø§Ù„ÙˆØ­Ø¯Ø©</th><th>Ø§Ù„ØªÙƒÙ„ÙØ© Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠØ© (Ø±ÙŠØ§Ù„)</th></tr>';
  }
}

function calcSales(){
  const tbl = document.getElementById('salesTbl');
  const sumTbl = document.getElementById('salesSummary');
  if(!tbl || !sumTbl) return;

  // ØªØ£ÙƒØ¯ Ø£Ù† Ø§Ù„Ø®Ù„Ø·Ø§Øª ÙˆØ§Ù„Ù…Ù†ØªØ¬Ø§Øª Ù…Ø­Ø¯Ø«Ø©
  recalcMixes();
  calcProducts();
  refreshSalesProductList();

  const rows = Array.from(tbl.querySelectorAll('tr')).slice(1);
  // Ø§Ø³Ù… Ø§Ù„Ù…Ø§Ø¯Ø© -> {qty: Ø§Ù„ÙƒÙ…ÙŠØ© Ø§Ù„Ù…Ø³ØªÙ‡Ù„ÙƒØ©, cost: Ø§Ù„ØªÙƒÙ„ÙØ© Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠØ©, unit: Ø§Ù„ÙˆØ­Ø¯Ø© Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ©}
  const usage = {};
  rows.forEach(r=>{
    r.classList.remove('bad');
    const noteCell = r.querySelector('.sales-note');
    if(noteCell){
      noteCell.textContent = '';
    }
    const prodNameInput = r.querySelector('.sales-prod-name');
    const qtyInput = r.querySelector('.sales-qty');
    const prodName = (prodNameInput && prodNameInput.value || '').trim();
    const orders = parseFloat(qtyInput && qtyInput.value || '0') || 0;
    if(!prodName || orders <= 0){
      return;
    }

    // Ø§Ø¨Ø­Ø« Ø¹Ù† Ø¨Ù„ÙˆÙƒ Ø§Ù„Ù…Ù†ØªØ¬ Ø§Ù„ØµØ§Ù„Ø­
    const prodBlocks = document.querySelectorAll('.product-block:not(.bad)');
    let targetBlock = null;
    prodBlocks.forEach(block=>{
      const nameInput = block.querySelector('.prod-name');
      const name = (nameInput && nameInput.value || '').trim();
      if(name === prodName){
        targetBlock = block;
      }
    });

    if(!targetBlock){
      r.classList.add('bad');
      if(noteCell){
        noteCell.textContent = 'Ø§Ù„Ù…Ù†ØªØ¬ ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯ Ø£Ùˆ ÙŠØ­ØªÙˆÙŠ Ø¹Ù„Ù‰ Ø®Ø·Ø£ ÙÙŠ ØªÙƒÙ„ÙØªÙ‡ (Ø±Ø§Ø¬Ø¹ ØµÙØ­Ø© Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª)';
      }
      return;
    }

    const itemRows = targetBlock.querySelectorAll('table tr');
    itemRows.forEach((tr,idx)=>{
      if(idx === 0 || tr.classList.contains('bad')) return; // ØªØ®Ø·ÙŠ Ø§Ù„Ø±Ø£Ø³ ÙˆØ§Ù„Ø£Ø³Ø·Ø± Ø§Ù„Ø®Ø§Ø·Ø¦Ø© ÙÙŠ Ø§Ù„Ù…Ù†ØªØ¬
      const typeSel = tr.querySelector('.typeSelect');
      const nameInput = tr.querySelector('.nameInput');
      const qtyInputRow = tr.querySelector('td:nth-child(3) input');
      if(!typeSel || !nameInput || !qtyInputRow) return;

      const typeVal = typeSel.value;
      const name = (nameInput.value || '').trim();
      const qtyPerUnit = parseFloat(qtyInputRow.value || '0') || 0;
      if(!name || qtyPerUnit <= 0) return;

      if(typeVal === 'ing'){
        // Ù…Ø§Ø¯Ø© Ù…Ù† Ø§Ù„Ù…Ø®Ø²ÙˆÙ† Ù…Ø¨Ø§Ø´Ø±Ø©
        const ingItem = ing.find(i=>i.n === name);
        const basePrice = ingItem ? ingItem.basePrice : 0;
        const unit = ingItem ? ingItem.baseUnit : '';
        if(unit){
          if(!usage[name]) usage[name] = {qty: 0, cost: 0, unit: unit};
          const consumedQty = qtyPerUnit * orders;
          usage[name].qty += consumedQty;
          usage[name].cost += consumedQty * basePrice;
        }
      }else if(typeVal === 'mix'){
        // ØªÙˆØ³Ø¹Ø© Ø§Ù„Ø®Ù„Ø·Ø© Ø¥Ù„Ù‰ Ù…ÙˆØ§Ø¯ Ø®Ø§Ù…
        const mixObj = mixes.find(m=>m.name === name);
        if(mixObj && Array.isArray(mixObj.items) && mixObj.totalWeight > 0){
          const ratio = qtyPerUnit / mixObj.totalWeight;
          mixObj.items.forEach(it=>{
            const matName = it.material;
            const matQtyInMix = it.qty || 0;
            const ingItem = ing.find(i=>i.n === matName);
            const basePrice = ingItem ? ingItem.basePrice : 0;
            const unit = ingItem ? ingItem.baseUnit : '';

            if(matName && matQtyInMix > 0 && unit){
              if(!usage[matName]) usage[matName] = {qty: 0, cost: 0, unit: unit};
              const consumedQty = orders * ratio * matQtyInMix;
              usage[matName].qty += consumedQty;
              usage[matName].cost += consumedQty * basePrice;
            }
          });
        }
      }
    });
  });

  // Ø¨Ù†Ø§Ø¡ Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ù…Ù„Ø®Øµ
  let header = '<tr><th>Ø§Ø³Ù… Ø§Ù„Ù…Ø§Ø¯Ø©</th><th>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„ÙƒÙ…ÙŠØ© Ø§Ù„Ù…Ø³ØªÙ‡Ù„ÙƒØ©</th><th>Ø§Ù„ÙˆØ­Ø¯Ø©</th><th>Ø§Ù„ØªÙƒÙ„ÙØ© Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠØ© (Ø±ÙŠØ§Ù„)</th></tr>';
  const names = Object.keys(usage).sort();
  let rowsHtml = '';
  let grandTotalCost = 0;
  names.forEach(n=>{
    let label = usage[n].unit;
    if(label === 'g') label = 'Ø¬Ø±Ø§Ù…';
    else if(label === 'ml') label = 'Ù…Ù„';
    else if(label === 'pc') label = 'Ø­Ø¨Ø©';

    rowsHtml += `<tr><td>${n}</td><td>${usage[n].qty.toFixed(2)}</td><td>${label}</td><td>${usage[n].cost.toFixed(2)}</td></tr>`;
    grandTotalCost += usage[n].cost;
  });

  rowsHtml += `<tr style="font-weight:bold; background:#1f2937;">
                <td colspan="3" style="text-align:right; color:#f97316;">Ø¥Ø¬Ù…Ø§Ù„ÙŠ ØªÙƒÙ„ÙØ© Ø§Ù„Ù…ÙˆØ§Ø¯ Ø§Ù„Ù…Ø³ØªÙ‡Ù„ÙƒØ©</td>
                <td>${grandTotalCost.toFixed(2)}</td>
              </tr>`;

  sumTbl.innerHTML = header + rowsHtml;
}

// ØªÙ‡ÙŠØ¦Ø© Ø£ÙˆÙ„ÙŠØ©
addMixBlock();
addProductBlock();
updateAllLookupsAndUnits();
</script>
</body>
</html>
